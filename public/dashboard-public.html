<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public View | EVID-DGC</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <link rel="shortcut icon" href="favicon.png" type="image/png">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="responsive-improvements.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="fixed-navbar.js"></script>
    <script src="sample-data.js"></script>
    <style>
        .public-hero {
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
            padding: 40px 0;
            text-align: center;
            margin-bottom: 30px;
        }

        .hero-content h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .public-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }

        .public-cases {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .public-case-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #10b981;
        }

        .case-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            background: #d1fae5;
            color: #065f46;
        }

        .search-bar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
        }

        .search-input:focus {
            outline: none;
            border-color: #10b981;
        }

        .search-results-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .search-result-item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background: #f9fafb;
        }

        .search-result-item h5 {
            margin: 0 0 8px 0;
            color: #1f2937;
        }

        .case-summary {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #10b981;
        }

        .evidence-item {
            transition: all 0.2s ease;
        }

        .evidence-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>
    <!-- Navbar will be injected by navbar.js -->

    <!-- Hero Section -->
    <div class="public-hero">
        <div class="container">
            <div class="hero-content">
                <h1>üëÅÔ∏è Public Viewer Dashboard</h1>
                <p>Access public case information and evidence records</p>
                <div class="public-stats">
                    <div class="stat-card">
                        <span class="stat-number" id="publicCases">12</span>
                        <span>Public Cases</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="closedCases">8</span>
                        <span>Closed Cases</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="publicEvidence">45</span>
                        <span>Public Evidence</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Search Section -->
        <div class="search-bar">
            <h3 style="margin-bottom: 15px;">üîç Search Public Records</h3>
            <div style="display: flex; gap: 10px;">
                <input type="text" class="search-input" placeholder="Search by case ID, location, or keywords..."
                    id="searchInput">
                <button class="btn btn-primary" onclick="searchCases()">
                    <i data-lucide="search"></i>
                    Search
                </button>
            </div>
        </div>

        <!-- Public Cases -->
        <div class="card">
            <div class="card-header">
                <h2>üìã Public Cases</h2>
                <p>View publicly available case information</p>
            </div>
            <div class="card-body">
                <div class="public-cases" id="publicCasesGrid">
                    <div class="public-case-card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>Downtown Burglary Case</h3>
                            <span class="case-status">CLOSED</span>
                        </div>
                        <p><strong>Case ID:</strong> PUB-2024-001</p>
                        <p><strong>Location:</strong> Downtown District</p>
                        <p><strong>Date:</strong> February 15, 2024</p>
                        <p><strong>Status:</strong> Investigation Complete</p>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-sm btn-outline" onclick="viewCaseSummary('PUB-2024-001')">View
                                Summary</button>
                            <button class="btn btn-sm btn-outline" onclick="viewEvidenceList('PUB-2024-001')">Evidence
                                List</button>
                        </div>
                    </div>

                    <div class="public-case-card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>Public Safety Incident</h3>
                            <span class="case-status">CLOSED</span>
                        </div>
                        <p><strong>Case ID:</strong> PUB-2024-002</p>
                        <p><strong>Location:</strong> City Park</p>
                        <p><strong>Date:</strong> February 20, 2024</p>
                        <p><strong>Status:</strong> Resolved</p>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-sm btn-outline" onclick="viewCaseSummary('PUB-2024-002')">View
                                Summary</button>
                            <button class="btn btn-sm btn-outline" onclick="viewEvidenceList('PUB-2024-002')">Evidence
                                List</button>
                        </div>
                    </div>

                    <div class="public-case-card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>Traffic Investigation</h3>
                            <span class="case-status">CLOSED</span>
                        </div>
                        <p><strong>Case ID:</strong> PUB-2024-003</p>
                        <p><strong>Location:</strong> Main Street</p>
                        <p><strong>Date:</strong> February 25, 2024</p>
                        <p><strong>Status:</strong> Case Closed</p>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-sm btn-outline" onclick="viewCaseSummary('PUB-2024-003')">View
                                Summary</button>
                            <button class="btn btn-sm btn-outline" onclick="viewEvidenceList('PUB-2024-003')">Evidence
                                List</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Public Information -->
        <div class="card">
            <div class="card-header">
                <h2>‚ÑπÔ∏è Public Information</h2>
                <p>Important notices and system information</p>
            </div>
            <div class="card-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div
                        style="background: #f0f9ff; padding: 20px; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                        <h4>üîí Data Privacy</h4>
                        <p>All public records are filtered to protect sensitive information while maintaining
                            transparency.</p>
                    </div>
                    <div
                        style="background: #f0fdf4; padding: 20px; border-radius: 8px; border-left: 4px solid #22c55e;">
                        <h4>‚úÖ Verified Records</h4>
                        <p>All evidence and case information is blockchain-verified for authenticity and integrity.</p>
                    </div>
                    <div
                        style="background: #fefce8; padding: 20px; border-radius: 8px; border-left: 4px solid #eab308;">
                        <h4>üìÖ Regular Updates</h4>
                        <p>Public records are updated regularly as cases progress through the legal system.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Evidence Statistics -->
        <div class="card">
            <div class="card-header">
                <h2>üìä Evidence Statistics</h2>
                <p>Public evidence transparency metrics</p>
            </div>
            <div class="card-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div style="text-align: center; padding: 20px; background: #f8fafc; border-radius: 8px;">
                        <div style="font-size: 2rem; color: #3b82f6;">üì∏</div>
                        <div style="font-size: 1.5rem; font-weight: bold; margin: 10px 0;">28</div>
                        <div>Public Photos</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: #f8fafc; border-radius: 8px;">
                        <div style="font-size: 2rem; color: #10b981;">üìÑ</div>
                        <div style="font-size: 1.5rem; font-weight: bold; margin: 10px 0;">15</div>
                        <div>Public Documents</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: #f8fafc; border-radius: 8px;">
                        <div style="font-size: 2rem; color: #f59e0b;">üé•</div>
                        <div style="font-size: 1.5rem; font-weight: bold; margin: 10px 0;">2</div>
                        <div>Public Videos</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: #f8fafc; border-radius: 8px;">
                        <div style="font-size: 2rem; color: #ef4444;">üîí</div>
                        <div style="font-size: 1.5rem; font-weight: bold; margin: 10px 0;">100%</div>
                        <div>Verified</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', function () {
            lucide.createIcons();
            initializeDashboard();
        });

        async function initializeDashboard() {
            try {
                const currentUserRaw = localStorage.getItem('currentUser');
                if (!currentUserRaw) {
                    window.location.href = 'index.html';
                    return;
                }

                let userAccount = currentUserRaw;
                let userData = {};

                // Parse if it's a JSON object (new format)
                if (currentUserRaw.startsWith('{')) {
                    try {
                        const parsed = JSON.parse(currentUserRaw);
                        userData = parsed.user;
                        // Map fields if necessary
                        if (!userData.role) userData.role = parsed.user.role;

                        // Set userAccount for legacy lookups if needed (though we have userData now)
                        if (parsed.type === 'email') {
                            userAccount = userData.email;
                        } else {
                            userAccount = userData.walletAddress || userData.address;
                        }
                    } catch (e) {
                        console.error('Error parsing currentUser:', e);
                    }
                } else {
                    // Legacy
                    userData = JSON.parse(localStorage.getItem('evidUser_' + userAccount) || '{}');
                }

                if (!userData.role) {
                    // Try to get role from selectedRole if user data is missing
                    const selectedRole = localStorage.getItem('selectedRole');
                    if (selectedRole) {
                        userData.role = selectedRole;
                        userData.fullName = localStorage.getItem('testUserName') || 'Public Viewer';
                        userData.walletAddress = userAccount;
                        // Save the user data
                        localStorage.setItem('evidUser_' + userAccount, JSON.stringify(userData));
                    } else {
                        alert('User data not found. Please login again.');
                        logout();
                        return;
                    }
                }

                currentUser = userData;
                updateUserInterface();
                loadDashboardData();
                initializeTabs();

            } catch (error) {
                console.error('Dashboard initialization error:', error);
                alert('Failed to load dashboard. Please try again.');
            }
        }

        function initializeTabs() {
            // Add click handlers for tab navigation
            document.addEventListener('click', function (e) {
                if (e.target.matches('[data-tab]')) {
                    e.preventDefault();
                    const tabName = e.target.getAttribute('data-tab');
                    switchTab(tabName);
                }
            });
        }

        function switchTab(tabName) {
            console.log('Switching to tab:', tabName);

            switch (tabName) {
                case 'cases':
                    window.location.href = 'cases.html';
                    break;
                case 'search':
                    showSearchInterface();
                    break;
                default:
                    console.log('Unknown tab:', tabName);
            }
        }

        function showSearchInterface() {
            const searchModal = document.createElement('div');
            searchModal.className = 'modal active';
            searchModal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>üîç Search Cases & Evidence</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Search Term</label>
                            <input type="text" id="searchTerm" class="form-control" placeholder="Enter case ID, keywords, or location...">
                        </div>
                        <div class="form-group">
                            <label>Search Type</label>
                            <select id="searchType" class="form-control">
                                <option value="all">All Records</option>
                                <option value="cases">Cases Only</option>
                                <option value="evidence">Evidence Only</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button onclick="performSearch()" class="btn btn-primary">
                                <i data-lucide="search"></i> Search
                            </button>
                            <button onclick="this.closest('.modal').remove()" class="btn btn-outline">Cancel</button>
                        </div>
                        <div id="searchResults" class="search-results" style="margin-top: 20px;"></div>
                    </div>
                </div>
            `;
            document.body.appendChild(searchModal);
            lucide.createIcons();
        }

        function performSearch() {
            const searchTerm = document.getElementById('searchTerm').value.toLowerCase();
            const searchType = document.getElementById('searchType').value;
            const resultsDiv = document.getElementById('searchResults');

            if (!searchTerm.trim()) {
                resultsDiv.innerHTML = '<p class="text-warning">Please enter a search term.</p>';
                return;
            }

            const cases = JSON.parse(localStorage.getItem('cases') || '[]');
            const evidence = JSON.parse(localStorage.getItem('evidence') || '[]');

            let results = [];

            if (searchType === 'all' || searchType === 'cases') {
                const caseResults = cases.filter(c =>
                    (c.status === 'CLOSED' || c.isPublic) &&
                    (c.id.toLowerCase().includes(searchTerm) ||
                        c.title.toLowerCase().includes(searchTerm) ||
                        c.location?.toLowerCase().includes(searchTerm))
                ).map(c => ({ ...c, type: 'case' }));
                results = results.concat(caseResults);
            }

            if (searchType === 'all' || searchType === 'evidence') {
                const evidenceResults = evidence.filter(e =>
                    (e.isPublic || e.status === 'Verified') &&
                    (e.title.toLowerCase().includes(searchTerm) ||
                        e.description?.toLowerCase().includes(searchTerm))
                ).map(e => ({ ...e, type: 'evidence' }));
                results = results.concat(evidenceResults);
            }

            if (results.length > 0) {
                let html = `<h4>Search Results (${results.length} found):</h4><div class="search-results-list">`;
                results.forEach(item => {
                    if (item.type === 'case') {
                        html += `
                            <div class="search-result-item">
                                <h5>üìã Case: ${item.title}</h5>
                                <p><strong>ID:</strong> ${item.id} | <strong>Status:</strong> ${item.status}</p>
                                <p><strong>Location:</strong> ${item.location || 'N/A'} | <strong>Date:</strong> ${item.date}</p>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="search-result-item">
                                <h5>üìé Evidence: ${item.title}</h5>
                                <p><strong>Type:</strong> ${item.type} | <strong>Status:</strong> ${item.status}</p>
                                <p><strong>Case:</strong> ${item.case_id} | <strong>Date:</strong> ${new Date(item.timestamp).toLocaleDateString()}</p>
                            </div>
                        `;
                    }
                });
                html += '</div>';
                resultsDiv.innerHTML = html;
            } else {
                resultsDiv.innerHTML = `<p class="text-muted">No public records found matching "${searchTerm}".</p>`;
            }
        }

        function updateUserInterface() {
            const isTestUser = localStorage.getItem('testUserMode') === 'true';
            const userName = currentUser.fullName || currentUser.full_name || 'Public Viewer';

            const userRoleEl = document.getElementById('userRole');
            if (userRoleEl) {
                userRoleEl.textContent = isTestUser ?
                    `üëÅÔ∏è ${userName} (Test)` : `üëÅÔ∏è Public Viewer`;
            }

            const userWalletEl = document.getElementById('userWallet');
            if (userWalletEl && currentUser.walletAddress) {
                userWalletEl.textContent =
                    currentUser.walletAddress.slice(0, 6) + '...' + currentUser.walletAddress.slice(-4);
            }
        }

        function loadDashboardData() {
            // Load public cases from localStorage
            const cases = JSON.parse(localStorage.getItem('cases') || '[]');
            const evidence = JSON.parse(localStorage.getItem('evidence') || '[]');

            // Filter for public/closed cases only
            const publicCases = cases.filter(c => c.status === 'CLOSED' || c.isPublic);
            const publicEvidence = evidence.filter(e => e.isPublic || e.status === 'Verified');

            document.getElementById('publicCases').textContent = publicCases.length;
            document.getElementById('closedCases').textContent = cases.filter(c => c.status === 'CLOSED').length;
            document.getElementById('publicEvidence').textContent = publicEvidence.length;
        }

        function searchCases() {
            const searchTerm = document.getElementById('searchInput').value;
            if (searchTerm.trim()) {
                const cases = JSON.parse(localStorage.getItem('cases') || '[]');
                const publicCases = cases.filter(c => c.status === 'CLOSED' || c.isPublic);
                const results = publicCases.filter(c =>
                    c.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    c.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    c.location.toLowerCase().includes(searchTerm.toLowerCase())
                );

                if (results.length > 0) {
                    let resultText = `üîç Public Search Results for "${searchTerm}":\n\n`;
                    results.forEach(c => {
                        resultText += `‚Ä¢ ${c.id}: ${c.title} (${c.status})\n  Location: ${c.location}\n  Date: ${c.date}\n\n`;
                    });
                    alert(resultText);
                } else {
                    alert(`No public cases found matching "${searchTerm}"`);
                }
            } else {
                alert('Please enter a search term');
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.clear();
                window.location.href = 'index.html';
            }
        }

        function viewCaseSummary(caseId) {
            const caseData = {
                'PUB-2024-001': {
                    title: 'Downtown Burglary Case',
                    description: 'Investigation of commercial burglary in downtown district involving multiple businesses.',
                    officer: 'Detective Johnson',
                    dateOpened: 'February 15, 2024',
                    dateClosed: 'March 10, 2024',
                    status: 'Investigation Complete',
                    location: 'Downtown District',
                    evidenceCount: 12
                },
                'PUB-2024-002': {
                    title: 'Public Safety Incident',
                    description: 'Public safety incident at City Park involving vandalism and property damage.',
                    officer: 'Officer Smith',
                    dateOpened: 'February 20, 2024',
                    dateClosed: 'February 28, 2024',
                    status: 'Resolved',
                    location: 'City Park',
                    evidenceCount: 8
                },
                'PUB-2024-003': {
                    title: 'Traffic Investigation',
                    description: 'Traffic accident investigation on Main Street with multiple vehicles involved.',
                    officer: 'Sergeant Davis',
                    dateOpened: 'February 25, 2024',
                    dateClosed: 'March 5, 2024',
                    status: 'Case Closed',
                    location: 'Main Street',
                    evidenceCount: 15
                }
            };

            const data = caseData[caseId];
            if (!data) return;

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>üìã Case Summary - ${caseId}</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="case-summary">
                            <h4>${data.title}</h4>
                            <p><strong>Description:</strong> ${data.description}</p>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
                                <div><strong>Assigned Officer:</strong> ${data.officer}</div>
                                <div><strong>Location:</strong> ${data.location}</div>
                                <div><strong>Date Opened:</strong> ${data.dateOpened}</div>
                                <div><strong>Date Closed:</strong> ${data.dateClosed}</div>
                                <div><strong>Status:</strong> <span class="case-status">${data.status}</span></div>
                                <div><strong>Evidence Items:</strong> ${data.evidenceCount}</div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button onclick="this.closest('.modal').remove()" class="btn btn-outline">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            lucide.createIcons();
        }

        function viewEvidenceList(caseId) {
            const evidenceData = {
                'PUB-2024-001': [
                    { id: 'E001', type: 'Photo', description: 'Security camera footage', date: '2024-02-15', hash: 'abc123...' },
                    { id: 'E002', type: 'Document', description: 'Police report', date: '2024-02-15', hash: 'def456...' },
                    { id: 'E003', type: 'Photo', description: 'Crime scene photos', date: '2024-02-16', hash: 'ghi789...' }
                ],
                'PUB-2024-002': [
                    { id: 'E004', type: 'Photo', description: 'Damage assessment photos', date: '2024-02-20', hash: 'jkl012...' },
                    { id: 'E005', type: 'Document', description: 'Witness statements', date: '2024-02-21', hash: 'mno345...' }
                ],
                'PUB-2024-003': [
                    { id: 'E006', type: 'Photo', description: 'Accident scene photos', date: '2024-02-25', hash: 'pqr678...' },
                    { id: 'E007', type: 'Video', description: 'Traffic camera footage', date: '2024-02-25', hash: 'stu901...' },
                    { id: 'E008', type: 'Document', description: 'Vehicle inspection report', date: '2024-02-26', hash: 'vwx234...' }
                ]
            };

            const evidence = evidenceData[caseId] || [];

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>üìÅ Evidence List - ${caseId}</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="evidence-list">
                            ${evidence.length > 0 ? evidence.map(item => `
                                <div class="evidence-item" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <h5>${item.id} - ${item.description}</h5>
                                            <p><strong>Type:</strong> ${item.type} | <strong>Date:</strong> ${item.date}</p>
                                            <p><strong>Hash:</strong> <code style="font-size: 0.8em;">${item.hash}</code></p>
                                        </div>
                                        <div>
                                            <span class="badge" style="background: #10b981; color: white; padding: 4px 8px; border-radius: 4px;">Verified</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('') : '<p class="text-muted">No evidence items available for public viewing.</p>'}
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button onclick="this.closest('.modal').remove()" class="btn btn-outline">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            lucide.createIcons();
        }
    </script>
    <script src="footer.js"></script>
</body>

</html>