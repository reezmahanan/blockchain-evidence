/**\n * Evidence Tagging System - JavaScript Module\n * Provides comprehensive tagging functionality for evidence management\n */\n\nclass TagManager {\n    constructor(userWallet) {\n        this.userWallet = userWallet;\n        this.tags = [];\n        this.tagCache = new Map();\n        this.init();\n    }\n\n    async init() {\n        await this.loadTags();\n    }\n\n    // Load all tags from server\n    async loadTags() {\n        try {\n            const response = await fetch('/api/tags');\n            const data = await response.json();\n            \n            if (data.success) {\n                this.tags = data.tags;\n                this.updateTagCache();\n            }\n        } catch (error) {\n            console.error('Failed to load tags:', error);\n        }\n    }\n\n    // Update local tag cache\n    updateTagCache() {\n        this.tagCache.clear();\n        this.tags.forEach(tag => {\n            this.tagCache.set(tag.id, tag);\n        });\n    }\n\n    // Create new tag\n    async createTag(name, color = '#3B82F6', category = 'general') {\n        try {\n            const response = await fetch('/api/tags', {\n                method: 'POST',\n                headers: { 'Content-Type': 'application/json' },\n                body: JSON.stringify({\n                    name: name.trim(),\n                    color,\n                    category,\n                    userWallet: this.userWallet\n                })\n            });\n\n            const data = await response.json();\n            \n            if (data.success) {\n                this.tags.push(data.tag);\n                this.updateTagCache();\n                return data.tag;\n            } else {\n                throw new Error(data.error);\n            }\n        } catch (error) {\n            console.error('Failed to create tag:', error);\n            throw error;\n        }\n    }\n\n    // Add tags to evidence\n    async addTags(evidenceId, tagIds) {\n        try {\n            const response = await fetch(`/api/evidence/${evidenceId}/tags`, {\n                method: 'POST',\n                headers: { 'Content-Type': 'application/json' },\n                body: JSON.stringify({\n                    tagIds,\n                    userWallet: this.userWallet\n                })\n            });\n\n            const data = await response.json();\n            \n            if (!data.success) {\n                throw new Error(data.error);\n            }\n\n            return data.evidence_tags;\n        } catch (error) {\n            console.error('Failed to add tags:', error);\n            throw error;\n        }\n    }\n\n    // Remove tag from evidence\n    async removeTag(evidenceId, tagId) {\n        try {\n            const response = await fetch(`/api/evidence/${evidenceId}/tags/${tagId}`, {\n                method: 'DELETE',\n                headers: { 'Content-Type': 'application/json' },\n                body: JSON.stringify({\n                    userWallet: this.userWallet\n                })\n            });\n\n            const data = await response.json();\n            \n            if (!data.success) {\n                throw new Error(data.error);\n            }\n\n            return true;\n        } catch (error) {\n            console.error('Failed to remove tag:', error);\n            throw error;\n        }\n    }\n\n    // Batch tag multiple evidence items\n    async batchTag(evidenceIds, tagIds) {\n        try {\n            const response = await fetch('/api/evidence/batch-tag', {\n                method: 'POST',\n                headers: { 'Content-Type': 'application/json' },\n                body: JSON.stringify({\n                    evidenceIds,\n                    tagIds,\n                    userWallet: this.userWallet\n                })\n            });\n\n            const data = await response.json();\n            \n            if (!data.success) {\n                throw new Error(data.error);\n            }\n\n            return data.tagged_count;\n        } catch (error) {\n            console.error('Failed to batch tag:', error);\n            throw error;\n        }\n    }\n\n    // Filter evidence by tags\n    async filterByTags(tagIds, logic = 'AND') {\n        try {\n            const response = await fetch(`/api/evidence/by-tags?tagIds=${tagIds.join(',')}&logic=${logic}`);\n            const data = await response.json();\n            \n            if (!data.success) {\n                throw new Error(data.error);\n            }\n\n            return data.evidence;\n        } catch (error) {\n            console.error('Failed to filter by tags:', error);\n            throw error;\n        }\n    }\n\n    // Get tag suggestions\n    async getSuggestions(query, limit = 10) {\n        try {\n            const response = await fetch(`/api/tags/suggest?query=${encodeURIComponent(query)}&limit=${limit}`);\n            const data = await response.json();\n            \n            if (data.success) {\n                return data.suggestions;\n            }\n            return [];\n        } catch (error) {\n            console.error('Failed to get suggestions:', error);\n            return [];\n        }\n    }\n\n    // Create tag input component\n    createTagInput(containerId, options = {}) {\n        const container = document.getElementById(containerId);\n        if (!container) return;\n\n        const {\n            placeholder = 'Add tags...',\n            maxTags = 10,\n            allowCreate = true,\n            onTagAdd = () => {},\n            onTagRemove = () => {}\n        } = options;\n\n        container.innerHTML = `\n            <div class=\"tag-input-container\">\n                <div class=\"selected-tags\" id=\"${containerId}-selected\"></div>\n                <input type=\"text\" \n                       class=\"tag-input\" \n                       id=\"${containerId}-input\"\n                       placeholder=\"${placeholder}\"\n                       autocomplete=\"off\">\n                <div class=\"tag-suggestions\" id=\"${containerId}-suggestions\"></div>\n            </div>\n        `;\n\n        const input = container.querySelector('.tag-input');\n        const selectedContainer = container.querySelector('.selected-tags');\n        const suggestionsContainer = container.querySelector('.tag-suggestions');\n        \n        let selectedTags = [];\n        let debounceTimer;\n\n        // Input event handler\n        input.addEventListener('input', async (e) => {\n            clearTimeout(debounceTimer);\n            debounceTimer = setTimeout(async () => {\n                const query = e.target.value.trim();\n                if (query.length > 0) {\n                    const suggestions = await this.getSuggestions(query);\n                    this.renderSuggestions(suggestionsContainer, suggestions, (tag) => {\n                        this.addSelectedTag(tag, selectedContainer, selectedTags, onTagAdd);\n                        input.value = '';\n                        suggestionsContainer.innerHTML = '';\n                    });\n                } else {\n                    suggestionsContainer.innerHTML = '';\n                }\n            }, 300);\n        });\n\n        // Enter key handler\n        input.addEventListener('keydown', async (e) => {\n            if (e.key === 'Enter' && allowCreate) {\n                e.preventDefault();\n                const tagName = input.value.trim();\n                if (tagName && selectedTags.length < maxTags) {\n                    try {\n                        const newTag = await this.createTag(tagName);\n                        this.addSelectedTag(newTag, selectedContainer, selectedTags, onTagAdd);\n                        input.value = '';\n                        suggestionsContainer.innerHTML = '';\n                    } catch (error) {\n                        this.showError('Failed to create tag: ' + error.message);\n                    }\n                }\n            }\n        });\n\n        return {\n            getSelectedTags: () => selectedTags,\n            clearTags: () => {\n                selectedTags = [];\n                selectedContainer.innerHTML = '';\n            },\n            addTag: (tag) => this.addSelectedTag(tag, selectedContainer, selectedTags, onTagAdd)\n        };\n    }\n\n    // Add selected tag to UI\n    addSelectedTag(tag, container, selectedTags, onTagAdd) {\n        if (selectedTags.find(t => t.id === tag.id)) return;\n\n        selectedTags.push(tag);\n        \n        const tagElement = document.createElement('span');\n        tagElement.className = 'selected-tag';\n        tagElement.style.backgroundColor = tag.color;\n        tagElement.innerHTML = `\n            ${tag.name}\n            <button type=\"button\" class=\"remove-tag\" data-tag-id=\"${tag.id}\">&times;</button>\n        `;\n\n        tagElement.querySelector('.remove-tag').addEventListener('click', () => {\n            const index = selectedTags.findIndex(t => t.id === tag.id);\n            if (index > -1) {\n                selectedTags.splice(index, 1);\n                tagElement.remove();\n                onTagAdd(selectedTags);\n            }\n        });\n\n        container.appendChild(tagElement);\n        onTagAdd(selectedTags);\n    }\n\n    // Render tag suggestions\n    renderSuggestions(container, suggestions, onSelect) {\n        container.innerHTML = suggestions.map(tag => `\n            <div class=\"tag-suggestion\" data-tag-id=\"${tag.id}\">\n                <span class=\"tag-color\" style=\"background-color: ${tag.color}\"></span>\n                <span class=\"tag-name\">${tag.name}</span>\n                <span class=\"tag-usage\">${tag.usage_count}</span>\n            </div>\n        `).join('');\n\n        container.querySelectorAll('.tag-suggestion').forEach(el => {\n            el.addEventListener('click', () => {\n                const tagId = parseInt(el.dataset.tagId);\n                const tag = suggestions.find(t => t.id === tagId);\n                if (tag) onSelect(tag);\n            });\n        });\n    }\n\n    // Create tag filter component\n    createTagFilter(containerId, onFilter) {\n        const container = document.getElementById(containerId);\n        if (!container) return;\n\n        container.innerHTML = `\n            <div class=\"tag-filter-container\">\n                <div class=\"filter-controls\">\n                    <select class=\"filter-logic\" id=\"${containerId}-logic\">\n                        <option value=\"AND\">All tags (AND)</option>\n                        <option value=\"OR\">Any tag (OR)</option>\n                    </select>\n                    <button type=\"button\" class=\"clear-filter\">Clear Filter</button>\n                </div>\n                <div class=\"filter-tags\" id=\"${containerId}-tags\"></div>\n                <div class=\"available-tags\" id=\"${containerId}-available\"></div>\n            </div>\n        `;\n\n        const logicSelect = container.querySelector('.filter-logic');\n        const filterTags = container.querySelector('.filter-tags');\n        const availableTags = container.querySelector('.available-tags');\n        const clearButton = container.querySelector('.clear-filter');\n\n        let selectedFilterTags = [];\n\n        // Render available tags\n        this.renderAvailableTags(availableTags, (tag) => {\n            if (!selectedFilterTags.find(t => t.id === tag.id)) {\n                selectedFilterTags.push(tag);\n                this.renderFilterTags(filterTags, selectedFilterTags, (removedTag) => {\n                    selectedFilterTags = selectedFilterTags.filter(t => t.id !== removedTag.id);\n                    this.applyFilter(selectedFilterTags, logicSelect.value, onFilter);\n                });\n                this.applyFilter(selectedFilterTags, logicSelect.value, onFilter);\n            }\n        });\n\n        // Logic change handler\n        logicSelect.addEventListener('change', () => {\n            this.applyFilter(selectedFilterTags, logicSelect.value, onFilter);\n        });\n\n        // Clear filter handler\n        clearButton.addEventListener('click', () => {\n            selectedFilterTags = [];\n            filterTags.innerHTML = '';\n            onFilter(null);\n        });\n    }\n\n    // Render available tags for filtering\n    renderAvailableTags(container, onSelect) {\n        container.innerHTML = `\n            <h4>Available Tags</h4>\n            <div class=\"tag-grid\">\n                ${this.tags.map(tag => `\n                    <button type=\"button\" class=\"available-tag\" data-tag-id=\"${tag.id}\">\n                        <span class=\"tag-color\" style=\"background-color: ${tag.color}\"></span>\n                        ${tag.name}\n                        <span class=\"tag-count\">${tag.usage_count}</span>\n                    </button>\n                `).join('')}\n            </div>\n        `;\n\n        container.querySelectorAll('.available-tag').forEach(el => {\n            el.addEventListener('click', () => {\n                const tagId = parseInt(el.dataset.tagId);\n                const tag = this.tags.find(t => t.id === tagId);\n                if (tag) onSelect(tag);\n            });\n        });\n    }\n\n    // Render selected filter tags\n    renderFilterTags(container, tags, onRemove) {\n        container.innerHTML = `\n            <h4>Filter Tags</h4>\n            <div class=\"filter-tag-list\">\n                ${tags.map(tag => `\n                    <span class=\"filter-tag\" style=\"background-color: ${tag.color}\">\n                        ${tag.name}\n                        <button type=\"button\" class=\"remove-filter-tag\" data-tag-id=\"${tag.id}\">&times;</button>\n                    </span>\n                `).join('')}\n            </div>\n        `;\n\n        container.querySelectorAll('.remove-filter-tag').forEach(el => {\n            el.addEventListener('click', () => {\n                const tagId = parseInt(el.dataset.tagId);\n                const tag = tags.find(t => t.id === tagId);\n                if (tag) onRemove(tag);\n            });\n        });\n    }\n\n    // Apply tag filter\n    async applyFilter(tags, logic, onFilter) {\n        if (tags.length === 0) {\n            onFilter(null);\n            return;\n        }\n\n        try {\n            const tagIds = tags.map(t => t.id);\n            const filteredEvidence = await this.filterByTags(tagIds, logic);\n            onFilter(filteredEvidence);\n        } catch (error) {\n            console.error('Filter error:', error);\n            this.showError('Failed to apply filter');\n        }\n    }\n\n    // Show error message\n    showError(message) {\n        // Create or update error display\n        let errorDiv = document.getElementById('tag-error');\n        if (!errorDiv) {\n            errorDiv = document.createElement('div');\n            errorDiv.id = 'tag-error';\n            errorDiv.className = 'tag-error';\n            document.body.appendChild(errorDiv);\n        }\n        \n        errorDiv.textContent = message;\n        errorDiv.style.display = 'block';\n        \n        setTimeout(() => {\n            errorDiv.style.display = 'none';\n        }, 5000);\n    }\n\n    // Get tag by ID\n    getTag(id) {\n        return this.tagCache.get(id);\n    }\n\n    // Get tags by category\n    getTagsByCategory(category) {\n        return this.tags.filter(tag => tag.category === category);\n    }\n\n    // Get popular tags\n    getPopularTags(limit = 10) {\n        return this.tags\n            .sort((a, b) => b.usage_count - a.usage_count)\n            .slice(0, limit);\n    }\n}\n\n// Export for use in other modules\nif (typeof module !== 'undefined' && module.exports) {\n    module.exports = TagManager;\n} else {\n    window.TagManager = TagManager;\n}