<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Premium SEO & Meta -->
    <title>EVID-DGC ¬∑ Investigation Command Center</title>
    <meta name="description" content="Secure case management and evidence investigation platform - Blockchain verified">
    <meta name="theme-color" content="#d32f2f">
    
    <!-- Critical CSS -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="responsive-improvements.css">
    
    <!-- Favicon Suite -->
    <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    
    <!-- Premium Font Loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons - Pinned to specific version with Subresource Integrity -->
    <script src="https://unpkg.com/lucide@0.344.0" integrity="sha384-Kl3cQhNN0eOsiHm8vPcqgY72Lp6P/9GPQOJGfQnN/zTbtFTl4tYxQ+UqIsb0m0Y0" crossorigin="anonymous"></script>
    
</head>

<body>
    <!-- Navigation will be injected by navbar.js -->
    
    <!-- ===== PREMIUM INVESTIGATION HERO ===== -->
    <div class="investigation-hero">
        <div class="hero-content">
            <div class="hero-badge">
                <i data-lucide="badge"></i>
                <span>Investigation Division ‚Ä¢ Level 2 Clearance</span>
            </div>
            <h1>
                <span class="hero-highlight">Case Management</span><br>
                & Evidence Command
            </h1>
            <p class="hero-subtitle">
                Secure investigation platform with blockchain-verified evidence tracking. 
                Every case, every piece of evidence, immutably recorded.
            </p>
            
            <!-- Premium Stats Cards -->
            <div class="stats-grid-premium">
                <div class="stat-card-premium">
                    <div class="stat-icon">
                        <i data-lucide="folder"></i>
                    </div>
                    <div class="stat-number" id="activeCases">0</div>
                    <div class="stat-label">Active Cases</div>
                </div>
                <div class="stat-card-premium">
                    <div class="stat-icon">
                        <i data-lucide="file"></i>
                    </div>
                    <div class="stat-number" id="evidenceItems">0</div>
                    <div class="stat-label">Evidence Items</div>
                </div>
                <div class="stat-card-premium">
                    <div class="stat-icon">
                        <i data-lucide="clock"></i>
                    </div>
                    <div class="stat-number" id="pendingReviews">0</div>
                    <div class="stat-label">Pending Review</div>
                </div>
                <div class="stat-card-premium">
                    <div class="stat-icon">
                        <i data-lucide="check-circle"></i>
                    </div>
                    <div class="stat-number" id="verifiedItems">0</div>
                    <div class="stat-label">Verified Items</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <!-- ===== PREMIUM QUICK ACTIONS ===== -->
        <div class="card" style="margin-top: 0;">
            <div class="section-header">
                <div>
                    <h2>Quick Actions</h2>
                    <p>Essential investigation tools at your fingertips</p>
                </div>
                <button class="btn btn-outline btn-sm" onclick="refreshDashboard()">
                    <i data-lucide="refresh-cw"></i>
                    Sync Data
                </button>
            </div>
            
            <div class="actions-grid-premium">
                <div class="action-card-premium" onclick="createNewCase()">
                    <div class="action-icon">
                        <i data-lucide="folder-plus"></i>
                    </div>
                    <h3>Create New Case</h3>
                    <p>Start a new investigation with blockchain-secured case management</p>
                </div>
                
                <div class="action-card-premium" onclick="uploadEvidence()">
                    <div class="action-icon">
                        <i data-lucide="upload"></i>
                    </div>
                    <h3>Upload Evidence</h3>
                    <p>Add digital evidence with instant hash verification and timestamping</p>
                </div>
                
                <div class="action-card-premium" onclick="searchCases()">
                    <div class="action-icon">
                        <i data-lucide="search"></i>
                    </div>
                    <h3>Search Cases</h3>
                    <p>Advanced search across all investigations and evidence records</p>
                </div>
                
                <div class="action-card-premium" onclick="generateReport()">
                    <div class="action-icon">
                        <i data-lucide="file-bar-chart"></i>
                    </div>
                    <h3>Generate Report</h3>
                    <p>Create comprehensive investigation reports with chain of custody</p>
                </div>
                
                <div class="action-card-premium" onclick="window.location.href='evidence-comparison.html'">
                    <div class="action-icon">
                        <i data-lucide="git-compare"></i>
                    </div>
                    <h3>Compare Evidence</h3>
                    <p>Side-by-side forensic evidence comparison with hash verification</p>
                </div>
                
                <div class="action-card-premium" onclick="window.location.href='evidence-tagging.html'">
                    <div class="action-icon">
                        <i data-lucide="tags"></i>
                    </div>
                    <h3>Tag Evidence</h3>
                    <p>Organize and categorize evidence with smart tagging system</p>
                </div>
            </div>
        </div>
        
        <!-- ===== PREMIUM RECENT CASES ===== -->
        <div class="card">
            <div class="cases-header">
                <div>
                    <h2>Active Investigations</h2>
                    <p>Recent cases requiring attention</p>
                </div>
                <div class="cases-filters">
                    <button class="filter-chip active" onclick="filterCases(event, 'all')">
                        <i data-lucide="list"></i>
                        All
                    </button>
                    <button class="filter-chip" onclick="filterCases(event, 'open')">
                        <i data-lucide="folder"></i>
                        Open
                    </button>
                    <button class="filter-chip" onclick="filterCases(event, 'analyzing')">
                        <i data-lucide="activity"></i>
                        Analyzing
                    </button>
                    <button class="filter-chip" onclick="filterCases(event, 'closed')">
                        <i data-lucide="archive"></i>
                        Closed
                    </button>
                </div>
            </div>
            
            <div class="cases-grid-premium" id="casesGrid">
                <!-- Case cards will be dynamically inserted here -->
            </div>
        </div>
        
        <!-- ===== PREMIUM EVIDENCE MANAGEMENT ===== -->
        <div class="card">
            <div class="section-header">
                <div>
                    <h2>Evidence Overview</h2>
                    <p>Blockchain-verified evidence inventory</p>
                </div>
                <div class="verified-badge">
                    <i data-lucide="shield"></i>
                    <span>100% Blockchain Verified</span>
                </div>
            </div>
            
            <div class="evidence-stats-premium">
                <div class="evidence-stat-card">
                    <div class="evidence-stat-icon">
                        <i data-lucide="camera"></i>
                    </div>
                    <div class="evidence-stat-info">
                        <div class="evidence-stat-number">12</div>
                        <div class="evidence-stat-label">Photos</div>
                    </div>
                </div>
                
                <div class="evidence-stat-card">
                    <div class="evidence-stat-icon">
                        <i data-lucide="file-text"></i>
                    </div>
                    <div class="evidence-stat-info">
                        <div class="evidence-stat-number">8</div>
                        <div class="evidence-stat-label">Documents</div>
                    </div>
                </div>
                
                <div class="evidence-stat-card">
                    <div class="evidence-stat-icon">
                        <i data-lucide="video"></i>
                    </div>
                    <div class="evidence-stat-info">
                        <div class="evidence-stat-number">3</div>
                        <div class="evidence-stat-label">Videos</div>
                    </div>
                </div>
                
                <div class="evidence-stat-card">
                    <div class="evidence-stat-icon">
                        <i data-lucide="mic"></i>
                    </div>
                    <div class="evidence-stat-info">
                        <div class="evidence-stat-number">5</div>
                        <div class="evidence-stat-label">Audio</div>
                    </div>
                </div>
                
                <div class="evidence-stat-card">
                    <div class="evidence-stat-icon">
                        <i data-lucide="hard-drive"></i>
                    </div>
                    <div class="evidence-stat-info">
                        <div class="evidence-stat-number">19</div>
                        <div class="evidence-stat-label">Digital Files</div>
                    </div>
                </div>
                
                <div class="evidence-stat-card">
                    <div class="evidence-stat-icon">
                        <i data-lucide="package"></i>
                    </div>
                    <div class="evidence-stat-info">
                        <div class="evidence-stat-number">7</div>
                        <div class="evidence-stat-label">Physical Items</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ===== PREMIUM MODAL ===== -->
    <div id="investigationModal" class="modal-premium">
        <div class="modal-content-premium">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="font-size: 24px; font-weight: 700; color: var(--investigation-gray-900);" id="modalTitle">
                    Case Details
                </h2>
                <button onclick="closeModal()" style="background: none; border: none; cursor: pointer; padding: 8px;">
                    <i data-lucide="x" style="width: 20px; height: 20px; color: var(--investigation-gray-500);"></i>
                </button>
            </div>
            <div id="modalContent">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
    </div>
    
    <script src="fixed-navbar.js"></script>
    <script>
        // ===== PREMIUM INVESTIGATION DASHBOARD =====
        // Strict Red & White Theme - No Blue Allowed
        
        let currentUser = null;
        let currentFilter = 'all';
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Lucide icons
            lucide.createIcons();
            // Initialize dashboard
            initializeInvestigationDashboard();
        });
        
        async function initializeInvestigationDashboard() {
            try {
                // Check authentication
                const userAccount = localStorage.getItem('currentUser');
                if (!userAccount) {
                    window.location.href = 'index.html';
                    return;
                }
                
                // Load user data with error handling
                let userData = null;
                try {
                    userData = JSON.parse(localStorage.getItem('evidUser_' + userAccount) || '{}');
                } catch (e) {
                    console.error('Failed to parse user data:', e);
                    userData = {};
                }
                
                if (!userData.role) {
                    const selectedRole = localStorage.getItem('selectedRole');
                    if (selectedRole) {
                        userData.role = selectedRole;
                        userData.fullName = localStorage.getItem('testUserName') || 'Investigator';
                        userData.walletAddress = userAccount;
                        try {
                            localStorage.setItem('evidUser_' + userAccount, JSON.stringify(userData));
                        } catch (e) {
                            console.error('Failed to save user data:', e);
                        }
                    } else {
                        showToast('Session expired. Please login again.', 'error');
                        setTimeout(() => logout(), 2000);
                        return;
                    }
                }
                
                currentUser = userData;
                updateUserInterface();
                loadInvestigationData();
                
            } catch (error) {
                console.error('Investigation dashboard error:', error);
                showToast('Failed to initialize dashboard', 'error');
            }
        }
        
        function updateUserInterface() {
            const isTestUser = localStorage.getItem('testUserMode') === 'true';
            const userName = currentUser.fullName || 'Investigator';
            
            const userRoleEl = document.getElementById('userRole');
            const userWalletEl = document.getElementById('userWallet');
            
            if (userRoleEl) {
                userRoleEl.textContent = isTestUser ? `üïµÔ∏è ${userName} (Test)` : 'üïµÔ∏è Senior Investigator';
            }
            
            if (userWalletEl && currentUser.walletAddress) {
                userWalletEl.textContent = currentUser.walletAddress.slice(0, 6) + '...' + currentUser.walletAddress.slice(-4);
            }
        }
        
        // HTML escaping function to prevent XSS
        function escapeHtml(value) {
            if (value === undefined || value === null) return '';
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        
        // Helper function to normalize status values (convert to lowercase for comparison)
        function normalizeStatus(status) {
            if (status === undefined || status === null) return '';
            return String(status).toLowerCase();
        }
        
        function loadInvestigationData() {
            // Safely load cases from localStorage with error handling
            let cases = [];
            try {
                const casesData = localStorage.getItem('cases');
                if (casesData) {
                    cases = JSON.parse(casesData);
                    if (!Array.isArray(cases)) {
                        console.warn('Stored cases is not an array, resetting to empty array');
                        cases = [];
                        localStorage.removeItem('cases');
                    }
                }
            } catch (e) {
                console.error('Failed to parse stored cases:', e);
                cases = [];
                localStorage.removeItem('cases');
            }
            
            // Safely load evidence from localStorage with error handling
            let evidence = [];
            try {
                const evidenceData = localStorage.getItem('evidence');
                if (evidenceData) {
                    evidence = JSON.parse(evidenceData);
                    if (!Array.isArray(evidence)) {
                        console.warn('Stored evidence is not an array, resetting to empty array');
                        evidence = [];
                        localStorage.removeItem('evidence');
                    }
                }
            } catch (e) {
                console.error('Failed to parse stored evidence:', e);
                evidence = [];
                localStorage.removeItem('evidence');
            }
            
            // Calculate actual counts from data using case-insensitive comparison
            const activeCasesCount = cases.filter(c => {
                const status = normalizeStatus(c.status);
                return status === 'open' || status === 'analyzing';
            }).length;
            
            const evidenceItemsCount = evidence.length;
            
            const pendingReviewsCount = evidence.filter(e => {
                const status = normalizeStatus(e.status);
                return status === 'pending';
            }).length;
            
            const verifiedItemsCount = evidence.filter(e => {
                const status = normalizeStatus(e.status);
                return status === 'verified';
            }).length;
            
            // Animate stats with actual values (no fallbacks to allow zero counts)
            animateValue('activeCases', 0, activeCasesCount, 800);
            animateValue('evidenceItems', 0, evidenceItemsCount, 800);
            animateValue('pendingReviews', 0, pendingReviewsCount, 800);
            animateValue('verifiedItems', 0, verifiedItemsCount, 800);
            
            // Update cases grid with real data if available
            if (cases.length > 0) {
                updateCasesGrid(cases.slice(0, 3));
            } else {
                // Show empty state when no cases
                const casesGrid = document.getElementById('casesGrid');
                if (casesGrid) {
                    casesGrid.innerHTML = `
                        <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 48px;">
                            <i data-lucide="folder-open" style="width: 48px; height: 48px; color: var(--investigation-gray-400); margin-bottom: 16px;"></i>
                            <h3 style="color: var(--investigation-gray-700); margin-bottom: 8px;">No Cases Found</h3>
                            <p style="color: var(--investigation-gray-500);">Create your first case to get started.</p>
                        </div>
                    `;
                    lucide.createIcons();
                }
            }
        }
        
        function animateValue(elementId, start, end, duration) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const range = end - start;
            const increment = range / (duration / 16);
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                if (current >= end) {
                    current = end;
                    clearInterval(timer);
                }
                element.textContent = Math.round(current);
            }, 16);
        }
        
        function updateCasesGrid(cases) {
            const casesGrid = document.getElementById('casesGrid');
            if (!casesGrid) return;
            
            // Build HTML with escaped values
            casesGrid.innerHTML = cases.map(c => {
                // Escape all user-provided content with safe status handling
                const escapedTitle = escapeHtml(c.title);
                const escapedId = escapeHtml(c.id);
                const escapedStatus = escapeHtml(c.status);
                // Use normalizeStatus for safe lowercase conversion
                const escapedStatusLower = escapeHtml(normalizeStatus(c.status));
                const escapedLocation = escapeHtml(c.location || 'Location TBD');
                const escapedDate = escapeHtml(c.date || 'Date TBD');
                const escapedOfficer = escapeHtml(c.officer || 'Unassigned');
                const escapedEvidenceCount = escapeHtml(String(c.evidenceCount || 0));
                
                return `
                    <div class="case-card-premium" data-status="${escapedStatusLower}">
                        <div class="case-header">
                            <div>
                                <h3 class="case-title">${escapedTitle}</h3>
                                <span class="case-id">${escapedId}</span>
                            </div>
                            <span class="status-badge ${escapedStatusLower}">
                                <i data-lucide="circle" style="width: 8px; height: 8px; margin-right: 4px;"></i>
                                ${escapedStatus}
                            </span>
                        </div>
                        <div class="case-details">
                            <div class="case-detail-item">
                                <i data-lucide="map-pin"></i>
                                <span>${escapedLocation}</span>
                            </div>
                            <div class="case-detail-item">
                                <i data-lucide="calendar"></i>
                                <span>${escapedDate}</span>
                            </div>
                            <div class="case-detail-item">
                                <i data-lucide="user"></i>
                                <span>Lead: ${escapedOfficer}</span>
                            </div>
                            <div class="case-detail-item">
                                <i data-lucide="file"></i>
                                <span>Evidence Items: ${escapedEvidenceCount}</span>
                            </div>
                        </div>
                        <div class="case-actions">
                            <button class="btn btn-primary btn-sm" onclick="viewCaseDetails('${escapedId}')">
                                <i data-lucide="eye"></i>
                                View Details
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="addEvidence('${escapedId}')">
                                <i data-lucide="plus"></i>
                                Add Evidence
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Reinitialize icons
            lucide.createIcons();
        }
        
        // ===== CASE ACTIONS =====
        function createNewCase() {
            const modalContent = `
                <div style="display: flex; flex-direction: column; gap: 24px;">
                    <div style="display: flex; gap: 16px; align-items: center;">
                        <div style="width: 64px; height: 64px; background: var(--investigation-red-muted); border-radius: 18px; display: flex; align-items: center; justify-content: center;">
                            <i data-lucide="folder-plus" style="width: 32px; height: 32px; color: var(--investigation-red);"></i>
                        </div>
                        <div>
                            <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 4px;">New Investigation Case</h3>
                            <p style="color: var(--investigation-gray-500);">Create a blockchain-secured case file</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 16px;">
                        <div class="form-group">
                            <label style="font-weight: 600; color: var(--investigation-gray-700);">Case Title *</label>
                            <input type="text" id="newCaseTitle" class="form-control" placeholder="e.g., Office Burglary Investigation" style="margin-top: 8px;">
                        </div>
                        
                        <div class="form-group">
                            <label style="font-weight: 600; color: var(--investigation-gray-700);">Location</label>
                            <input type="text" id="newCaseLocation" class="form-control" placeholder="Crime scene address" style="margin-top: 8px;">
                        </div>
                        
                        <div class="form-group">
                            <label style="font-weight: 600; color: var(--investigation-gray-700);">Description</label>
                            <textarea id="newCaseDescription" class="form-control" rows="3" placeholder="Brief description of the incident" style="margin-top: 8px;"></textarea>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 16px; justify-content: flex-end;">
                        <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="submitNewCase()">
                            <i data-lucide="check"></i>
                            Create Case
                        </button>
                    </div>
                </div>
            `;
            
            showModal('Create New Case', modalContent);
        }
        
        function submitNewCase() {
            const title = document.getElementById('newCaseTitle')?.value;
            if (!title) {
                showToast('Case title is required', 'error');
                return;
            }
            
            const caseId = 'INV-' + new Date().getFullYear() + '-' + String(Date.now()).slice(-6);
            const newCase = {
                id: caseId,
                title: title,
                status: 'OPEN',
                location: document.getElementById('newCaseLocation')?.value || 'Not specified',
                description: document.getElementById('newCaseDescription')?.value || '',
                date: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }),
                officer: currentUser?.fullName || 'Investigator',
                evidenceCount: 0,
                createdAt: new Date().toISOString()
            };
            
            // Save to localStorage with error handling
            try {
                const cases = JSON.parse(localStorage.getItem('cases') || '[]');
                cases.unshift(newCase);
                localStorage.setItem('cases', JSON.stringify(cases));
            } catch (e) {
                console.error('Failed to save case:', e);
                showToast('Failed to save case', 'error');
                return;
            }
            
            closeModal();
            showToast(`‚úÖ Case ${caseId} created successfully`, 'success');
            loadInvestigationData();
        }
        
        function uploadEvidence() {
            const modalContent = `
                <div style="display: flex; flex-direction: column; gap: 24px;">
                    <div style="display: flex; gap: 16px; align-items: center;">
                        <div style="width: 64px; height: 64px; background: var(--investigation-red-muted); border-radius: 18px; display: flex; align-items: center; justify-content: center;">
                            <i data-lucide="upload" style="width: 32px; height: 32px; color: var(--investigation-red);"></i>
                        </div>
                        <div>
                            <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 4px;">Upload Evidence</h3>
                            <p style="color: var(--investigation-gray-500);">Blockchain-verified evidence submission</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 16px;">
                        <div class="form-group">
                            <label style="font-weight: 600; color: var(--investigation-gray-700);">Case ID *</label>
                            <input type="text" id="evidenceCaseId" class="form-control" placeholder="e.g., INV-2024-001" style="margin-top: 8px;">
                        </div>
                        
                        <div class="form-group">
                            <label style="font-weight: 600; color: var(--investigation-gray-700);">Evidence File</label>
                            <input type="file" id="evidenceFile" class="form-control" style="margin-top: 8px; padding: 8px;">
                        </div>
                        
                        <div class="form-group">
                            <label style="font-weight: 600; color: var(--investigation-gray-700);">Description</label>
                            <textarea id="evidenceDescription" class="form-control" rows="2" placeholder="Describe the evidence" style="margin-top: 8px;"></textarea>
                        </div>
                    </div>
                    
                    <div style="background: var(--investigation-red-soft); padding: 16px; border-radius: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i data-lucide="shield" style="width: 20px; height: 20px; color: var(--investigation-red);"></i>
                            <span style="font-size: 14px; color: var(--investigation-gray-700);">
                                Evidence will be hashed and timestamped on the blockchain
                            </span>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 16px; justify-content: flex-end;">
                        <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="submitEvidenceUpload()">
                            <i data-lucide="upload"></i>
                            Upload & Verify
                        </button>
                    </div>
                </div>
            `;
            
            showModal('Upload Evidence', modalContent);
        }
        
        function submitEvidenceUpload() {
            const caseId = document.getElementById('evidenceCaseId')?.value;
            if (!caseId) {
                showToast('Case ID is required', 'error');
                return;
            }
            
            const fileInput = document.getElementById('evidenceFile');
            const file = fileInput?.files[0];
            
            if (!file) {
                showToast('Please select a file to upload', 'error');
                return;
            }
            
            const evidenceId = 'EVD-' + Date.now();
            const evidence = {
                id: evidenceId,
                caseId: caseId,
                fileName: file.name,
                fileSize: file.size,
                fileType: file.type,
                description: document.getElementById('evidenceDescription')?.value || '',
                uploadedBy: currentUser?.fullName || 'Investigator',
                uploadedAt: new Date().toISOString(),
                status: 'Verified',
                hash: 'sha256:' + Math.random().toString(36).substring(2, 15)
            };
            
            // Save to localStorage with error handling
            try {
                const evidenceList = JSON.parse(localStorage.getItem('evidence') || '[]');
                evidenceList.unshift(evidence);
                localStorage.setItem('evidence', JSON.stringify(evidenceList));
            } catch (e) {
                console.error('Failed to save evidence:', e);
                showToast('Failed to save evidence', 'error');
                return;
            }
            
            closeModal();
            showToast(`‚úÖ Evidence uploaded and verified on blockchain`, 'success');
            loadInvestigationData();
        }
        
        function viewCaseDetails(caseId) {
            // Safely parse cases with error handling
            let cases = [];
            try {
                cases = JSON.parse(localStorage.getItem('cases') || '[]');
            } catch (e) {
                console.error('Failed to parse cases:', e);
                cases = [];
            }
            
            let caseData = cases.find(c => c.id === caseId);
            
            if (!caseData) {
                showToast('Case not found', 'error');
                return;
            }
            
            // Escape all user-provided content with safe status handling
            const escapedTitle = escapeHtml(caseData.title);
            const escapedId = escapeHtml(caseData.id);
            const escapedStatus = escapeHtml(caseData.status);
            const escapedStatusLower = escapeHtml(normalizeStatus(caseData.status));
            const escapedLocation = escapeHtml(caseData.location);
            const escapedDate = escapeHtml(caseData.date);
            const escapedOfficer = escapeHtml(caseData.officer);
            const escapedPriority = escapeHtml(caseData.priority);
            const escapedDescription = escapeHtml(caseData.description || 'No description provided.');
            
            // Determine priority color
            let priorityColor = 'var(--investigation-gray-600)';
            if (caseData.priority === 'High') priorityColor = 'var(--investigation-red)';
            else if (caseData.priority === 'Medium') priorityColor = '#f59e0b';
            else if (caseData.priority === 'Low') priorityColor = '#10b981';
            
            const modalContent = `
                <div style="display: flex; flex-direction: column; gap: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="font-size: 20px; font-weight: 700; color: var(--investigation-gray-900);">${escapedTitle}</h3>
                            <p style="color: var(--investigation-gray-500); font-family: monospace; margin-top: 4px;">${escapedId}</p>
                        </div>
                        <span class="status-badge ${escapedStatusLower}">
                            ${escapedStatus}
                        </span>
                    </div>
                    
                    <div style="background: var(--investigation-red-soft); padding: 20px; border-radius: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <span style="font-size: 12px; color: var(--investigation-gray-500);">Location</span>
                                <p style="font-weight: 600; margin-top: 4px;">${escapedLocation}</p>
                            </div>
                            <div>
                                <span style="font-size: 12px; color: var(--investigation-gray-500);">Opened</span>
                                <p style="font-weight: 600; margin-top: 4px;">${escapedDate}</p>
                            </div>
                            <div>
                                <span style="font-size: 12px; color: var(--investigation-gray-500);">Lead Investigator</span>
                                <p style="font-weight: 600; margin-top: 4px;">${escapedOfficer}</p>
                            </div>
                            <div>
                                <span style="font-size: 12px; color: var(--investigation-gray-500);">Priority</span>
                                <p style="font-weight: 600; margin-top: 4px; color: ${priorityColor}">${escapedPriority}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <span style="font-size: 14px; font-weight: 600; color: var(--investigation-gray-700);">Case Description</span>
                        <p style="margin-top: 8px; color: var(--investigation-gray-600); line-height: 1.6;">
                            ${escapedDescription}
                        </p>
                    </div>
                    
                    <div style="display: flex; gap: 16px; margin-top: 8px;">
                        <button class="btn btn-primary" onclick="addEvidence('${escapedId}')" style="flex: 1;">
                            <i data-lucide="plus"></i>
                            Add Evidence
                        </button>
                        <button class="btn btn-outline" onclick="closeModal()" style="flex: 1;">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            showModal('Case Details', modalContent);
        }
        
        function addEvidence(caseId) {
            closeModal();
            uploadEvidence();
            // Pre-fill the case ID with a more reliable method
            setTimeout(() => {
                const caseIdInput = document.getElementById('evidenceCaseId');
                if (caseIdInput) caseIdInput.value = caseId;
            }, 100);
        }
        
        function requestAnalysis(caseId) {
            showToast(`üî¨ Analysis request submitted for ${escapeHtml(caseId)}`, 'info');
        }
        
        function viewReport(caseId) {
            const escapedId = escapeHtml(caseId);
            const reportId = 'RPT-' + caseId + '-' + Date.now().toString().slice(-6);
            const escapedReportId = escapeHtml(reportId);
            const currentDate = escapeHtml(new Date().toLocaleDateString());
            
            showModal(
                'Investigation Report',
                `<div style="display: flex; flex-direction: column; gap: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-size: 18px; font-weight: 700;">Case ${escapedId}</h3>
                        <span class="status-badge closed">CLOSED</span>
                    </div>
                    <div style="background: #f8fafc; padding: 20px; border-radius: 16px;">
                        <p style="color: var(--investigation-gray-700); margin-bottom: 12px;">
                            <strong>Case Resolution:</strong> Investigation complete. Evidence verified on blockchain.
                        </p>
                        <p style="color: var(--investigation-gray-600); font-size: 14px;">
                            <strong>Report ID:</strong> ${escapedReportId}<br>
                            <strong>Generated:</strong> ${currentDate}
                        </p>
                    </div>
                    <button class="btn btn-primary" onclick="downloadReport('${escapedId}')">
                        <i data-lucide="download"></i>
                        Download Full Report
                    </button>
                </div>`
            );
        }
        
        function archiveCase(caseId) {
            if (confirm('Archive this case? All evidence will remain accessible in the archive.')) {
                showToast(`üì¶ Case ${escapeHtml(caseId)} archived successfully`, 'success');
            }
        }
        
        function searchCases() {
            showModal(
                'Search Cases',
                `<div style="display: flex; flex-direction: column; gap: 20px;">
                    <div style="display: flex; gap: 12px;">
                        <input type="text" id="searchQuery" class="form-control" placeholder="Enter case ID, title, or location..." style="flex: 1;">
                        <button class="btn btn-primary" onclick="performSearch()">
                            <i data-lucide="search"></i>
                            Search
                        </button>
                    </div>
                    <div style="color: var(--investigation-gray-500); font-size: 14px;">
                        Search across all investigations and evidence records
                    </div>
                </div>`
            );
        }
        
        function performSearch() {
            const query = document.getElementById('searchQuery')?.value;
            if (!query) {
                showToast('Please enter a search term', 'error');
                return;
            }
            
            showToast(`üîç Searching for "${escapeHtml(query)}"...`, 'info');
            setTimeout(() => {
                showToast(`Found 3 results matching "${escapeHtml(query)}"`, 'success');
            }, 1500);
        }
        
        function generateReport() {
            showModal(
                'Generate Investigation Report',
                `<div style="display: flex; flex-direction: column; gap: 24px;">
                    <div style="display: flex; gap: 16px; align-items: center;">
                        <div style="width: 64px; height: 64px; background: var(--investigation-red-muted); border-radius: 18px; display: flex; align-items: center; justify-content: center;">
                            <i data-lucide="file-bar-chart" style="width: 32px; height: 32px; color: var(--investigation-red);"></i>
                        </div>
                        <div>
                            <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 4px;">Report Generator</h3>
                            <p style="color: var(--investigation-gray-500);">Comprehensive case analysis</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 16px;">
                        <div class="form-group">
                            <label style="font-weight: 600; color: var(--investigation-gray-700);">Report Type</label>
                            <select class="form-control" style="margin-top: 8px;">
                                <option>Case Summary Report</option>
                                <option>Evidence Inventory Report</option>
                                <option>Chain of Custody Report</option>
                                <option>Forensic Analysis Report</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label style="font-weight: 600; color: var(--investigation-gray-700);">Date Range</label>
                            <div style="display: flex; gap: 8px; margin-top: 8px;">
                                <input type="date" class="form-control" placeholder="From">
                                <input type="date" class="form-control" placeholder="To">
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 16px; justify-content: flex-end;">
                        <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="generateReportSubmit()">
                            <i data-lucide="file-text"></i>
                            Generate Report
                        </button>
                    </div>
                </div>`
            );
        }
        
        function generateReportSubmit() {
            closeModal();
            showToast('üìä Report generation started', 'info');
            setTimeout(() => {
                showToast('‚úÖ Report generated successfully', 'success');
            }, 2000);
        }
        
        function refreshDashboard() {
            showToast('üîÑ Syncing investigation data...', 'info');
            setTimeout(() => {
                loadInvestigationData();
                showToast('‚úÖ Dashboard synchronized', 'success');
            }, 1500);
        }
        
        // ===== FILTER FUNCTIONS =====
        function filterCases(event, filter) {
            currentFilter = filter;
            
            // Update active state
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            
            // Add active class to clicked button (event is explicitly passed)
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
            
            // Filter case cards
            const cards = document.querySelectorAll('.case-card-premium');
            cards.forEach(card => {
                if (filter === 'all') {
                    card.style.display = 'block';
                } else {
                    const status = card.dataset.status;
                    card.style.display = status === filter ? 'block' : 'none';
                }
            });
            
            showToast(`Filtered: Showing ${filter} cases`, 'info');
        }
        
        // ===== MODAL FUNCTIONS =====
        function showModal(title, content) {
            const modal = document.getElementById('investigationModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            
            modalTitle.textContent = title;
            modalContent.innerHTML = content;
            modal.classList.add('active');
            
            // Reinitialize icons in modal
            lucide.createIcons();
        }
        
        function closeModal() {
            document.getElementById('investigationModal').classList.remove('active');
        }
        
        // ===== TOAST FUNCTIONS =====
        function showToast(message, type = 'info') {
            // Escape message to prevent XSS
            const escapedMessage = escapeHtml(message);
            
            const toast = document.createElement('div');
            toast.className = `toast-premium ${type}`;
            
            let icon = 'info';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'alert-circle';
            
            toast.innerHTML = `
                <div class="toast-icon">
                    <i data-lucide="${icon}" style="width: 24px; height: 24px; color: ${type === 'success' ? '#10b981' : type === 'error' ? '#d32f2f' : '#3b82f6'}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                    <div class="toast-message">${escapedMessage}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i data-lucide="x" style="width: 16px; height: 16px;"></i>
                </button>
            `;
            
            document.body.appendChild(toast);
            lucide.createIcons();
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }
        
        function downloadReport(caseId) {
            showToast(`üì• Downloading report for ${escapeHtml(caseId)}`, 'info');
            closeModal();
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.clear();
                window.location.href = 'index.html';
            }
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('investigationModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
    <script src="footer.js"></script>
</body>

</html>