<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Premium SEO & Meta -->
    <title>EVID-DGC Â· Admin Command Center</title>
    <meta name="description" content="Secure blockchain evidence management system - Enterprise dashboard">
    <meta name="theme-color" content="#d32f2f">
    
    <!-- Critical CSS First -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="responsive-improvements.css">
    
    <!-- Favicon Suite -->
    <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    
    <!-- Premium Font Loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons - Pinned to specific version with Subresource Integrity -->
    <script src="https://unpkg.com/lucide@0.344.0" integrity="sha384-Kl3cQhNN0eOsiHm8vPcqgY72Lp6P/9GPQOJGfQnN/zTbtFTl4tYxQ+UqIsb0m0Y0" crossorigin="anonymous"></script>
    
    <!-- Google Analytics - Premium Tracking -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KEYDE0ZH4Z"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-KEYDE0ZH4Z', {
            'send_page_view': true,
            'anonymize_ip': true,
            'cookie_flags': 'SameSite=None;Secure'
        });
    </script>
</head>

<body>
    <!-- ===== PREMIUM DASHBOARD ROUTER ===== -->
    
    <!-- Loading State - Premium Experience -->
    <div id="loadingState" class="dashboard-loader">
        <div class="loader-card">
            <div class="loader-icon">
                <i data-lucide="fingerprint"></i>
            </div>
            <h2>Accessing Command Center</h2>
            <p>Establishing secure blockchain connection & loading your personalized workspace</p>
            <div class="progress-premium">
                <div class="progress-fill" id="progressFill" style="width: 10%;"></div>
            </div>
            <span class="progress-text" id="progressMessage">Initializing secure session...</span>
        </div>
    </div>
    
    <!-- Error State - Premium Design -->
    <div id="errorState" class="error-state-premium hidden">
        <div class="error-card">
            <div class="error-icon-wrapper">
                <i data-lucide="shield-alert"></i>
            </div>
            <h2>Access Restricted</h2>
            <p id="errorMessage">Unable to verify your credentials. Please try again or contact system administrator.</p>
            <div class="error-actions">
                <button onclick="retryDashboardLoad()" class="btn btn-primary">
                    <i data-lucide="refresh-cw"></i>
                    Retry Connection
                </button>
                <button onclick="goToLogin()" class="btn btn-outline">
                    <i data-lucide="log-out"></i>
                    Return to Login
                </button>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="storage.js"></script>
    
    <script>
        // ===== PREMIUM DASHBOARD ROUTER =====
        // Role-based dashboard routing with cinematic loading experience
        
        const ROLE_DASHBOARDS = {
            // String-based roles
            'admin': 'admin.html',
            'investigator': 'dashboard-investigator.html',
            'forensic_analyst': 'dashboard-analyst.html',
            'legal_professional': 'dashboard-legal.html',
            'court_official': 'dashboard-court.html',
            'evidence_manager': 'dashboard-manager.html',
            'auditor': 'dashboard-auditor.html',
            'public_viewer': 'dashboard-public.html',
            
            // Number-based roles (backward compatibility)
            '1': 'dashboard-public.html',
            '2': 'dashboard-investigator.html',
            '3': 'dashboard-analyst.html',
            '4': 'dashboard-legal.html',
            '5': 'dashboard-court.html',
            '6': 'dashboard-manager.html',
            '7': 'dashboard-auditor.html',
            '8': 'admin.html',
            1: 'dashboard-public.html',
            2: 'dashboard-investigator.html',
            3: 'dashboard-analyst.html',
            4: 'dashboard-legal.html',
            5: 'dashboard-court.html',
            6: 'dashboard-manager.html',
            7: 'dashboard-auditor.html',
            8: 'admin.html'
        };
        
        const ROLE_NAMES = {
            'admin': 'System Administrator',
            'investigator': 'Senior Investigator',
            'forensic_analyst': 'Forensic Analyst',
            'legal_professional': 'Legal Counsel',
            'court_official': 'Court Official',
            'evidence_manager': 'Evidence Manager',
            'auditor': 'Compliance Auditor',
            'public_viewer': 'Public Viewer',
            '1': 'Public Viewer',
            '2': 'Senior Investigator',
            '3': 'Forensic Analyst',
            '4': 'Legal Counsel',
            '5': 'Court Official',
            '6': 'Evidence Manager',
            '7': 'Compliance Auditor',
            '8': 'System Administrator'
        };
        
        // Role icons for enhanced UX
        const ROLE_ICONS = {
            'admin': 'shield',
            'investigator': 'badge',
            'forensic_analyst': 'microscope',
            'legal_professional': 'scale',
            'court_official': 'gavel',
            'evidence_manager': 'database',
            'auditor': 'clipboard-check',
            'public_viewer': 'eye'
        };
        
        // User cache for performance optimization
        const userCache = new Map();
        
        let retryCount = 0;
        const MAX_RETRIES = 2;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Lucide icons
            lucide.createIcons();
            // Start dashboard initialization
            initializeDashboard();
        });
        
        async function initializeDashboard() {
            try {
                // Step 1: Initializing
                updateProgress('Initializing secure environment...', 15);
                await sleep(400);
                
                // Step 2: Check authentication
                updateProgress('Verifying credentials...', 30);
                await sleep(300);
                
                const currentUserRaw = localStorage.getItem('currentUser');
                
                if (!currentUserRaw) {
                    window.location.replace('index.html');
                    return;
                }
                
                // Step 3: Loading user profile
                updateProgress('Loading user profile...', 45);
                await sleep(300);
                
                let userAccount = currentUserRaw;
                let userData = null;
                
                // Parse user data if JSON format - WITH ERROR HANDLING
                if (currentUserRaw.startsWith('{')) {
                    try {
                        const parsed = JSON.parse(currentUserRaw);
                        // Validate parsed data structure
                        if (parsed && typeof parsed === 'object') {
                            userData = parsed.user;
                            if (parsed.type === 'email') {
                                userAccount = userData?.email || userAccount;
                            } else {
                                userAccount = userData?.walletAddress || userData?.address || userAccount;
                            }
                        }
                    } catch (e) {
                        console.error('Failed to parse user data JSON:', e);
                        // If parsing fails, treat as corrupted and clear it
                        localStorage.removeItem('currentUser');
                        showError('User data corrupted. Please login again.');
                        return;
                    }
                }
                
                // Step 4: Retrieving role
                updateProgress('Configuring workspace...', 60);
                await sleep(300);
                
                // Get user data if not already parsed (with cache and error handling)
                if (!userData) {
                    userData = await getUserInfo(userAccount);
                }
                
                // Get selected role with safe fallback
                let finalRole = null;
                try {
                    finalRole = localStorage.getItem('selectedRole');
                } catch (e) {
                    console.error('Failed to read selectedRole:', e);
                }
                
                if (!finalRole && userData && userData.role) {
                    finalRole = userData.role;
                    try {
                        localStorage.setItem('selectedRole', finalRole);
                    } catch (e) {
                        console.error('Failed to save selectedRole:', e);
                    }
                }
                
                if (!finalRole) {
                    finalRole = 'public_viewer';
                    try {
                        localStorage.setItem('selectedRole', finalRole);
                    } catch (e) {
                        console.error('Failed to save default role:', e);
                    }
                }
                
                // Step 5: Preparing dashboard
                updateProgress('Loading dashboard components...', 75);
                await sleep(400);
                
                const userInfo = {
                    role: finalRole,
                    roleName: ROLE_NAMES[finalRole] || 'User',
                    roleIcon: ROLE_ICONS[finalRole] || 'user',
                    fullName: userData ? userData.fullName || userData.full_name || 'User' : 'User',
                    walletAddress: userAccount
                };
                
                // Step 6: Almost ready
                updateProgress('Establishing blockchain connection...', 90);
                await sleep(500);
                
                // Track successful access
                if (typeof gtag === 'function') {
                    gtag('event', 'dashboard_access', {
                        'user_role': userInfo.roleName,
                        'dashboard_url': getDashboardUrl(finalRole)
                    });
                }
                
                // Step 7: Complete
                updateProgress('Redirecting to dashboard...', 100);
                await sleep(300);
                
                // Redirect to role-specific dashboard
                window.location.replace(getDashboardUrl(finalRole));
                
            } catch (error) {
                console.error('Dashboard initialization error:', {
                    message: error.message,
                    stack: error.stack,
                    currentUser: localStorage.getItem('currentUser'),
                    retryCount
                });
                
                if (retryCount < MAX_RETRIES) {
                    retryCount++;
                    updateProgress(`Retrying connection (${retryCount}/${MAX_RETRIES})...`, 30);
                    await sleep(1000);
                    initializeDashboard();
                } else {
                    showError(error.message || 'Unable to load dashboard. Please try again.');
                }
            }
        }
        
        async function getUserInfo(userAccount) {
            // Check cache first (performance optimization)
            if (userCache.has(userAccount)) {
                return userCache.get(userAccount);
            }
            
            // Try to get from localStorage with error handling
            try {
                const savedUser = localStorage.getItem('evidUser_' + userAccount);
                if (!savedUser) return null;
                
                try {
                    const parsed = JSON.parse(savedUser);
                    // Validate parsed data
                    if (parsed && typeof parsed === 'object') {
                        userCache.set(userAccount, parsed); // Cache for future use
                        return parsed;
                    } else {
                        console.warn('Invalid user data format, clearing');
                        localStorage.removeItem('evidUser_' + userAccount);
                        return null;
                    }
                } catch (e) {
                    console.error('Error parsing user data:', e);
                    // Clear corrupted data
                    localStorage.removeItem('evidUser_' + userAccount);
                    return null;
                }
            } catch (e) {
                console.error('Error accessing localStorage:', e);
                return null;
            }
        }
        
        function getDashboardUrl(role) {
            return ROLE_DASHBOARDS[role] || 'dashboard-public.html';
        }
        
        function updateProgress(message, percentage) {
            const progressFill = document.getElementById('progressFill');
            const progressMessage = document.getElementById('progressMessage');
            
            if (progressFill) {
                progressFill.style.width = percentage + '%';
            }
            
            if (progressMessage) {
                progressMessage.textContent = message;
            }
        }
        
        function showError(message) {
            const loadingState = document.getElementById('loadingState');
            const errorState = document.getElementById('errorState');
            const errorMessage = document.getElementById('errorMessage');
            
            if (loadingState) loadingState.classList.add('hidden');
            if (errorState) errorState.classList.remove('hidden');
            if (errorMessage) errorMessage.textContent = message;
            
            // Track error
            if (typeof gtag === 'function') {
                gtag('event', 'dashboard_error', {
                    'error_message': message
                });
            }
            
            // Reinitialize icons
            lucide.createIcons();
        }
        
        function retryDashboardLoad() {
            const loadingState = document.getElementById('loadingState');
            const errorState = document.getElementById('errorState');
            
            loadingState.classList.remove('hidden');
            errorState.classList.add('hidden');
            
            updateProgress('Reconnecting to secure server...', 10);
            retryCount = 0;
            
            setTimeout(() => {
                initializeDashboard();
            }, 500);
        }
        
        function goToLogin() {
            // Clear sensitive data
            try {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('selectedRole');
            } catch (e) {
                console.error('Error clearing localStorage:', e);
            }
            
            // Redirect to login
            window.location.href = 'index.html';
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
