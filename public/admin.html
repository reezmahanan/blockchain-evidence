<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | EVID-DGC</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="favicon.png">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="responsive-improvements.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="config.js"></script>
    <script src="storage.js"></script>
    <script src="simple-notifications.js"></script>
    <script src="indian-apis.js"></script>
    <script src="fixed-navbar.js"></script>
    <script src="role-change-approval.js"></script>
</head>

<body>
    <!-- Navbar will be injected by navbar.js -->

    <div class="container">
        <div class="dashboard-hero">
            <h1>Administrator Dashboard</h1>
            <p>Manage users and system operations</p>
        </div>

        <!-- System Overview -->
        <div class="admin-section card">
            <div class="card-header">
                <h2>System Overview</h2>
                <p>Real-time system statistics</p>
            </div>
            <div class="card-body">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i data-lucide="users"></i></div>
                        <div class="stat-info">
                            <h3 id="totalUsers">0</h3>
                            <p>Total Users</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i data-lucide="file-text"></i></div>
                        <div class="stat-info">
                            <h3 id="totalEvidence">0</h3>
                            <p>Evidence Items</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i data-lucide="folder"></i></div>
                        <div class="stat-info">
                            <h3 id="totalCases">0</h3>
                            <p>Active Cases</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create User -->
        <div class="admin-section card">
            <div class="card-header">
                <h2>Create New User</h2>
                <p>Add a new user account</p>
            </div>
            <div class="card-body">
                <form id="createUserForm" class="admin-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="userWalletAddress">
                                <i data-lucide="wallet"></i>
                                Wallet Address *
                            </label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="userWalletAddress" class="form-control" placeholder="0x..."
                                    required style="flex: 1;">
                                <button type="button" class="btn btn-outline btn-sm" onclick="autoFillWalletAddress()">
                                    Generate
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="userFirstName">
                                <i data-lucide="user"></i>
                                First Name *
                            </label>
                            <input type="text" id="userFirstName" class="form-control" placeholder="Enter first name"
                                required>
                        </div>
                        <div class="form-group">
                            <label for="userLastName">
                                <i data-lucide="user"></i>
                                Last Name *
                            </label>
                            <input type="text" id="userLastName" class="form-control" placeholder="Enter last name"
                                required>
                        </div>
                        <div class="form-group">
                            <label for="userEmail">
                                <i data-lucide="mail"></i>
                                Email Address *
                            </label>
                            <input type="email" id="userEmail" class="form-control" placeholder="user@example.com"
                                required>
                        </div>
                        <div class="form-group">
                            <label for="userRole">
                                <i data-lucide="users"></i>
                                Role *
                            </label>
                            <select id="userRole" class="form-control" required>
                                <option value="">Select Role</option>
                                <option value="public_viewer">Public Viewer</option>
                                <option value="investigator">Investigator</option>
                                <option value="forensic_analyst">Forensic Analyst</option>
                                <option value="legal_professional">Legal Professional</option>
                                <option value="court_official">Court Official</option>
                                <option value="evidence_manager">Evidence Manager</option>
                                <option value="auditor">Auditor</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="userDepartment">
                                <i data-lucide="building"></i>
                                Department
                            </label>
                            <input type="text" id="userDepartment" class="form-control" placeholder="Enter department">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success">
                            <i data-lucide="user-plus"></i>
                            Create User
                        </button>
                        <button type="button" class="btn btn-outline" onclick="resetUserForm()">
                            <i data-lucide="refresh-cw"></i>
                            Reset
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Test Accounts -->
        <div class="admin-section card">
            <div class="card-header">
                <h2>Test Accounts</h2>
                <p>Create and manage test accounts for development</p>
            </div>
            <div class="card-body">
                <div class="admin-form" style="background: #e8f5e8; border: 2px solid #28a745;">
                    <h3>Quick Setup</h3>
                    <p>Create test accounts for all user roles:</p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button id="createAllTestAccounts" class="btn btn-success btn-lg"
                            onclick="createAllTestAccounts()">
                            <i data-lucide="plus"></i>
                            Create All Test Accounts
                        </button>
                        <button class="btn btn-warning" onclick="forceRecreateTestAccounts()">
                            <i data-lucide="refresh-cw"></i>
                            Recreate All
                        </button>
                    </div>
                    <div id="allTestStatus" class="mt-3"></div>
                </div>

                <div class="admin-section" style="margin-top: 30px;">
                    <h3>Role Testing Dashboard</h3>
                    <div id="roleTestingGrid" class="stats-grid">
                        <!-- Will be populated with role cards -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Role Change Approval -->
        <div id="pending-requests"></div>

        <!-- User Management -->
        <div class="admin-section card">
            <div class="card-header">
                <h2>ðŸ‘¥ User Management</h2>
                <p>Manage system users and administrator privileges</p>
                <div class="card-actions">
                    <button class="btn btn-primary" onclick="showAddAdminModal()">
                        <i data-lucide="user-plus"></i>
                        Add New Admin
                    </button>
                    <button class="btn btn-outline" onclick="loadAllUsers()">
                        <i data-lucide="refresh-cw"></i>
                        Refresh Users
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <span id="userCount" class="text-muted">Loading...</span>
                </div>

                <div class="table-container">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Wallet</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="5" class="text-center">Loading users...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentAdmin = null;

        document.addEventListener('DOMContentLoaded', async function () {
            lucide.createIcons();
            await checkAdminAuth();
            await createDefaultTestAccounts();
            await loadSystemOverview();
            await loadAllUsers();
            await loadRoleTestingDashboard();
            await loadPendingRoleRequests();
            initializeEventListeners();

            // Test notification after everything loads
            setTimeout(() => {
                if (window.simpleNotifications) {
                    window.simpleNotifications.addNotification(
                        'Admin Dashboard Ready',
                        'All systems operational!',
                        'system'
                    );
                }
            }, 2000);
        });

        async function createDefaultTestAccounts() {
            const testRoles = [
                { role: 'public_viewer', name: 'Test Public Viewer' },
                { role: 'investigator', name: 'Test Investigator' },
                { role: 'forensic_analyst', name: 'Test Forensic Analyst' },
                { role: 'legal_professional', name: 'Test Legal Professional' },
                { role: 'court_official', name: 'Test Court Official' },
                { role: 'evidence_manager', name: 'Test Evidence Manager' },
                { role: 'auditor', name: 'Test Auditor' }
            ];

            testRoles.forEach((testRole, index) => {
                const testWallet = `0xtest${testRole.role}${(1000 + index).toString()}`;
                const existingKey = `evidUser_${testWallet}`;

                const existingTest = Object.keys(localStorage)
                    .filter(key => key.startsWith('evidUser_0xtest'))
                    .find(key => {
                        try {
                            const userData = JSON.parse(localStorage.getItem(key));
                            return userData.role === testRole.role && userData.fullName === testRole.name;
                        } catch (e) {
                            return false;
                        }
                    });

                if (!existingTest) {
                    const testUserData = {
                        walletAddress: testWallet,
                        fullName: testRole.name,
                        firstName: 'Test',
                        lastName: testRole.name.replace('Test ', ''),
                        email: `${testRole.role}@test.com`,
                        role: testRole.role,
                        department: 'Test Department',
                        accountType: 'test',
                        isRegistered: true,
                        registrationDate: new Date().toISOString(),
                        createdBy: currentAdmin
                    };
                    localStorage.setItem(existingKey, JSON.stringify(testUserData));
                }
            });

            await loadRoleTestingDashboard();
        }

        async function createAllTestAccounts() {
            const button = document.getElementById('createAllTestAccounts');
            const status = document.getElementById('allTestStatus');

            button.disabled = true;
            button.innerHTML = '<i data-lucide="loader"></i> Creating...';

            const testRoles = [
                { role: 'public_viewer', name: 'Test Public Viewer' },
                { role: 'investigator', name: 'Test Investigator' },
                { role: 'forensic_analyst', name: 'Test Forensic Analyst' },
                { role: 'legal_professional', name: 'Test Legal Professional' },
                { role: 'court_official', name: 'Test Court Official' },
                { role: 'evidence_manager', name: 'Test Evidence Manager' },
                { role: 'auditor', name: 'Test Auditor' }
            ];

            let created = 0;

            testRoles.forEach((testRole, index) => {
                const testWallet = `0xtest${testRole.role}${1000 + index}`;
                const existingTest = localStorage.getItem(`evidUser_${testWallet}`);

                if (!existingTest) {
                    const testUserData = {
                        walletAddress: testWallet,
                        fullName: testRole.name,
                        firstName: 'Test',
                        lastName: testRole.name.replace('Test ', ''),
                        email: `${testRole.role}@test.com`,
                        role: testRole.role,
                        department: 'Test Department',
                        accountType: 'test',
                        isRegistered: true,
                        registrationDate: new Date().toISOString(),
                        createdBy: currentAdmin
                    };
                    localStorage.setItem(`evidUser_${testWallet}`, JSON.stringify(testUserData));
                    created++;
                }
            });

            status.innerHTML = `<div class="alert alert-success">Created ${created} test accounts</div>`;

            await loadRoleTestingDashboard();
            await loadAllUsers();

            setTimeout(() => status.innerHTML = '', 3000);
            button.disabled = false;
            button.innerHTML = '<i data-lucide="plus"></i> Create All Test Accounts';
            lucide.createIcons();
        }

        async function loadRoleTestingDashboard() {
            const testRoles = [
                { role: 'public_viewer', name: 'Public Viewer', icon: 'eye', description: 'View public cases' },
                { role: 'investigator', name: 'Investigator', icon: 'search', description: 'Create investigations' },
                { role: 'forensic_analyst', name: 'Forensic Analyst', icon: 'microscope', description: 'Analyze evidence' },
                { role: 'legal_professional', name: 'Legal Professional', icon: 'scale', description: 'Legal review' },
                { role: 'court_official', name: 'Court Official', icon: 'building', description: 'Court proceedings' },
                { role: 'evidence_manager', name: 'Evidence Manager', icon: 'clipboard-list', description: 'Manage evidence' },
                { role: 'auditor', name: 'Auditor', icon: 'audit', description: 'System auditing' }
            ];

            const testAccounts = Object.keys(localStorage)
                .filter(key => key.startsWith('evidUser_0xtest'))
                .map(key => {
                    try {
                        const userData = JSON.parse(localStorage.getItem(key));
                        return {
                            wallet_address: userData.walletAddress,
                            role: userData.role
                        };
                    } catch (e) {
                        return null;
                    }
                })
                .filter(account => account !== null);

            const grid = document.getElementById('roleTestingGrid');

            grid.innerHTML = testRoles.map(role => {
                const account = testAccounts.find(acc => acc.role === role.role);
                const hasAccount = !!account;

                return `
                    <div class="stat-card ${hasAccount ? 'test-ready' : 'test-missing'}" style="${hasAccount ? 'border: 2px solid #28a745;' : 'border: 2px solid #ffc107;'}">
                        <div class="stat-icon"><i data-lucide="${role.icon}"></i></div>
                        <div class="stat-info">
                            <h4>${role.name}</h4>
                            <p>${role.description}</p>
                            ${hasAccount ?
                        `<button class="btn btn-sm btn-success" onclick="testRoleInterface('${account.wallet_address}', '${role.name}')">
                                    <i data-lucide="play"></i> Test Interface
                                </button>
                                <button class="btn btn-sm btn-outline" onclick="copyToClipboard('${account.wallet_address}')">
                                    <i data-lucide="copy"></i> Copy Wallet
                                </button>` :
                        `<button class="btn btn-sm btn-warning" onclick="createSingleTestAccount('${role.role}', 'Test ${role.name}')">
                                    <i data-lucide="plus"></i> Create Account
                                </button>`
                    }
                        </div>
                    </div>
                `;
            }).join('');

            lucide.createIcons();
        }

        async function createSingleTestAccount(role, name) {
            const testWallet = `0xtest${role}${Math.random().toString(36).substring(2, 8)}`;
            const testUserData = {
                walletAddress: testWallet,
                fullName: name,
                role: role,
                department: 'Test Department',
                accountType: 'test',
                isRegistered: true,
                registrationDate: new Date().toISOString(),
                createdBy: currentAdmin
            };

            localStorage.setItem(`evidUser_${testWallet}`, JSON.stringify(testUserData));
            showAlert(`Test account created for ${name}!`, 'success');
            await loadRoleTestingDashboard();
            await loadAllUsers();
        }

        function testRoleInterface(walletAddress, roleName) {
            try {
                let testUserData = localStorage.getItem('evidUser_' + walletAddress);

                if (!testUserData) {
                    showAlert('Test user data not found. Please recreate test accounts.', 'error');
                    return;
                }

                testUserData = JSON.parse(testUserData);

                // Clear any existing user data
                localStorage.removeItem('currentUser');
                localStorage.removeItem('testUserMode');
                localStorage.removeItem('testUserName');
                localStorage.removeItem('selectedRole');
                localStorage.removeItem('roleWizardCompleted');

                // Set the new user data with proper role mapping
                localStorage.setItem('currentUser', walletAddress);
                localStorage.setItem('testUserMode', 'true');
                localStorage.setItem('testUserName', roleName);
                localStorage.setItem('selectedRole', testUserData.role);
                localStorage.setItem('roleWizardCompleted', 'true');

                // Ensure user data is properly stored
                const updatedUserData = {
                    ...testUserData,
                    isRegistered: true,
                    registrationDate: testUserData.registrationDate || new Date().toISOString()
                };
                localStorage.setItem('evidUser_' + walletAddress, JSON.stringify(updatedUserData));

                console.log('Test role setup complete:', {
                    currentUser: walletAddress,
                    selectedRole: testUserData.role,
                    testUserMode: 'true',
                    userData: updatedUserData
                });

                showAlert(`Testing ${roleName} interface...`, 'success');

                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1000);

            } catch (error) {
                console.error('Error testing interface:', error);
                showAlert('Error testing interface: ' + error.message, 'error');
            }
        }

        async function checkAdminAuth() {
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                window.location.href = 'index.html';
                return;
            }

            try {
                let userData;
                if (currentUser.startsWith('email_')) {
                    userData = JSON.parse(localStorage.getItem('evidUser_' + currentUser) || '{}');
                } else {
                    userData = JSON.parse(localStorage.getItem('evidUser_' + currentUser) || '{}');
                }

                // Allow any user to be admin for development - remove this check completely
                // const isAdmin = userData.role === 8 || userData.role === 'admin' || userData.accountType === 'admin';

                // if (!isAdmin) {
                //     alert('Access denied. Administrator privileges required.');
                //     window.location.href = 'index.html';
                //     return;
                // }

                // Force admin role for any logged in user
                if (!userData.role) {
                    userData.role = 'admin';
                    userData.accountType = 'admin';
                    localStorage.setItem('evidUser_' + currentUser, JSON.stringify(userData));
                }

                currentAdmin = currentUser;
                const displayWallet = currentUser.startsWith('email_') ? 'Email Login' : currentUser.substring(0, 8) + '...';
                const adminWalletEl = document.getElementById('adminWallet');
                if (adminWalletEl) {
                    adminWalletEl.textContent = displayWallet;
                }

                autoFillWalletAddress();

            } catch (error) {
                console.error('Admin auth error:', error);
                // Don't redirect on error, just continue
                currentAdmin = currentUser;
            }
        }

        function initializeEventListeners() {
            document.getElementById('createUserForm').addEventListener('submit', handleCreateUser);
        }

        async function handleCreateUser(event) {
            event.preventDefault();

            try {
                const walletAddress = document.getElementById('userWalletAddress').value.trim();
                const firstName = document.getElementById('userFirstName').value.trim();
                const lastName = document.getElementById('userLastName').value.trim();
                const email = document.getElementById('userEmail').value.trim();
                const role = document.getElementById('userRole').value;
                const department = document.getElementById('userDepartment').value.trim();

                if (!walletAddress.match(/^0x[a-fA-F0-9]{40}$/)) {
                    throw new Error('Invalid wallet address format');
                }

                if (!role) {
                    throw new Error('Please select a role');
                }

                if (!firstName || !lastName || !email) {
                    throw new Error('Please fill in all required fields');
                }

                const userData = {
                    walletAddress,
                    fullName: `${firstName} ${lastName}`,
                    firstName,
                    lastName,
                    email,
                    role,
                    department: department || 'General',
                    accountType: 'real',
                    isRegistered: true,
                    registrationDate: new Date().toISOString(),
                    createdBy: currentAdmin
                };

                // Try to create user via backend API first
                try {
                    const response = await fetch('/api/admin/create-user', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            adminWallet: currentAdmin,
                            userData: {
                                walletAddress,
                                fullName: userData.fullName,
                                role,
                                department: userData.department,
                                jurisdiction: 'General',
                                badgeNumber: ''
                            }
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        showAlert('User account created successfully in database!', 'success');
                    } else {
                        console.warn('Backend creation failed, using localStorage fallback');
                    }
                } catch (error) {
                    console.warn('Backend not available, using localStorage:', error);
                }

                // Always store in localStorage as well for immediate display
                localStorage.setItem(`evidUser_${walletAddress}`, JSON.stringify(userData));

                showAlert('User account created successfully!', 'success');
                document.getElementById('createUserForm').reset();
                await loadAllUsers();
            } catch (error) {
                showAlert('Error creating user: ' + error.message, 'error');
            }
        }

        async function loadAllUsers() {
            try {
                // Try to load from backend first
                const response = await fetch('/api/admin/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        adminWallet: currentAdmin
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    displayUsers(data.users || []);
                    return;
                }
            } catch (error) {
                console.warn('Backend not available, using localStorage:', error);
            }

            // Fallback to localStorage
            try {
                const keys = Object.keys(localStorage);
                const users = keys
                    .filter(key => key.startsWith('evidUser_'))
                    .map(key => {
                        try {
                            const userData = JSON.parse(localStorage.getItem(key));
                            return {
                                wallet_address: userData.walletAddress || key.replace('evidUser_', ''),
                                full_name: userData.fullName || userData.firstName + ' ' + userData.lastName || 'Unknown',
                                email: userData.email || 'N/A',
                                role: userData.role || userData.userRole || 1,
                                account_type: userData.accountType || 'real',
                                is_active: userData.is_active !== false,
                                created_at: userData.registrationDate || new Date().toISOString()
                            };
                        } catch (e) {
                            console.error('Error parsing user data for key:', key, e);
                            return null;
                        }
                    })
                    .filter(user => user !== null);

                displayUsers(users);
            } catch (error) {
                console.error('Error loading users from localStorage:', error);
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading users</td></tr>';
            }
        }

        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            const userCount = document.getElementById('userCount');

            userCount.textContent = `Total Users: ${users.length}`;

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr class="${!user.is_active ? 'inactive-user' : ''} ${user.account_type === 'test' ? 'test-account' : ''}">
                    <td>${user.email} ${user.account_type === 'test' ? '<span class="badge" style="background: #ffc107; color: #000; font-size: 0.7em;">TEST</span>' : ''}</td>
                    <td class="wallet-address">${user.wallet_address.slice(0, 8)}...${user.wallet_address.slice(-6)}</td>
                    <td><span class="badge badge-${getRoleClass(user.role)}">${formatRole(user.role)}</span></td>
                    <td><span class="status-badge ${user.is_active ? 'status-active' : 'status-inactive'}">${user.is_active ? 'Active' : 'Inactive'}</span></td>
                    <td class="action-buttons">
                        ${user.wallet_address !== currentAdmin ? `
                            ${user.role !== 'admin' && user.role !== 8 ? `
                                <button class="btn btn-sm btn-warning" onclick="makeAdmin('${user.wallet_address}', '${user.full_name}')" title="Make Admin">
                                    <i data-lucide="shield-plus"></i>
                                    Make Admin
                                </button>
                            ` : `
                                <span class="badge badge-admin">Admin</span>
                            `}
                            <button class="btn btn-sm btn-danger" onclick="deactivateUser('${user.wallet_address}', '${user.full_name}')" title="Deactivate User">
                                <i data-lucide="user-x"></i>
                                Deactivate
                            </button>
                        ` : '<span class="text-muted">Current Admin</span>'}
                    </td>
                </tr>
            `).join('');

            lucide.createIcons();
        }

        function showAddAdminModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>ðŸ‘¥ Add New Administrator</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="addAdminForm">
                            <div class="form-group">
                                <label>Email Address *</label>
                                <input type="email" id="adminEmail" class="form-control" placeholder="admin@example.com" required>
                            </div>
                            <div class="form-group">
                                <label>Wallet Address *</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" id="adminWallet" class="form-control" placeholder="0x..." required style="flex: 1;">
                                    <button type="button" class="btn btn-outline btn-sm" onclick="generateWallet()">
                                        Generate
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Full Name *</label>
                                <input type="text" id="adminName" class="form-control" placeholder="Administrator Name" required>
                            </div>
                            <div class="form-group">
                                <label>Role</label>
                                <select id="adminRole" class="form-control">
                                    <option value="admin">Administrator</option>
                                    <option value="auditor">Auditor</option>
                                    <option value="evidence_manager">Evidence Manager</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-actions">
                        <button onclick="submitNewAdmin()" class="btn btn-primary">
                            <i data-lucide="user-plus"></i>
                            Add Administrator
                        </button>
                        <button onclick="this.closest('.modal').remove()" class="btn btn-outline">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            lucide.createIcons();
        }

        function generateWallet() {
            const chars = '0123456789abcdef';
            let result = '0x';
            for (let i = 0; i < 40; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('adminWallet').value = result;
        }

        function submitNewAdmin() {
            const email = document.getElementById('adminEmail').value.trim();
            const wallet = document.getElementById('adminWallet').value.trim();
            const name = document.getElementById('adminName').value.trim();
            const role = document.getElementById('adminRole').value;

            if (!email || !wallet || !name) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }

            if (!wallet.match(/^0x[a-fA-F0-9]{40}$/)) {
                showAlert('Invalid wallet address format', 'error');
                return;
            }

            // Check if user already exists
            if (localStorage.getItem(`evidUser_${wallet}`)) {
                showAlert('User with this wallet address already exists', 'error');
                return;
            }

            const adminData = {
                walletAddress: wallet,
                fullName: name,
                email: email,
                role: role,
                department: 'Administration',
                accountType: 'real',
                isRegistered: true,
                registrationDate: new Date().toISOString(),
                createdBy: currentAdmin
            };

            localStorage.setItem(`evidUser_${wallet}`, JSON.stringify(adminData));

            // Log admin action
            logAdminAction('create_admin', wallet, {
                email: email,
                name: name,
                role: role
            });

            document.querySelector('.modal').remove();
            showAlert(`Administrator ${name} created successfully!`, 'success');
            loadAllUsers();
        }

        function makeAdmin(walletAddress, userName) {
            if (!confirm(`Are you sure you want to make ${userName} an administrator?\n\nThis will grant them full system access.`)) {
                return;
            }

            try {
                const userData = JSON.parse(localStorage.getItem(`evidUser_${walletAddress}`));
                userData.role = 'admin';
                userData.department = 'Administration';
                userData.promotedBy = currentAdmin;
                userData.promotedAt = new Date().toISOString();

                localStorage.setItem(`evidUser_${walletAddress}`, JSON.stringify(userData));

                // Log admin action
                logAdminAction('promote_admin', walletAddress, {
                    previousRole: userData.role,
                    newRole: 'admin',
                    userName: userName
                });

                showAlert(`${userName} has been promoted to Administrator`, 'success');
                loadAllUsers();
            } catch (error) {
                showAlert('Error promoting user: ' + error.message, 'error');
            }
        }

        function deactivateUser(walletAddress, userName) {
            if (!confirm(`Are you sure you want to deactivate ${userName}?\n\nThis will revoke their system access.`)) {
                return;
            }

            try {
                const userData = JSON.parse(localStorage.getItem(`evidUser_${walletAddress}`));
                userData.is_active = false;
                userData.deactivatedBy = currentAdmin;
                userData.deactivatedAt = new Date().toISOString();

                localStorage.setItem(`evidUser_${walletAddress}`, JSON.stringify(userData));

                // Log admin action
                logAdminAction('deactivate_user', walletAddress, {
                    userName: userName,
                    previousRole: userData.role
                });

                showAlert(`${userName} has been deactivated`, 'success');
                loadAllUsers();
            } catch (error) {
                showAlert('Error deactivating user: ' + error.message, 'error');
            }
        }

        function logAdminAction(actionType, targetWallet, details) {
            const auditLog = {
                id: Date.now(),
                adminWallet: currentAdmin,
                actionType: actionType,
                targetWallet: targetWallet,
                details: details,
                timestamp: new Date().toISOString()
            };

            const existingLogs = JSON.parse(localStorage.getItem('adminAuditLog') || '[]');
            existingLogs.unshift(auditLog);

            // Keep only last 100 logs
            if (existingLogs.length > 100) {
                existingLogs.splice(100);
            }

            localStorage.setItem('adminAuditLog', JSON.stringify(existingLogs));
        }

        async function loadSystemOverview() {
            try {
                // Try to get stats from backend first
                try {
                    const response = await fetch('/api/admin/users', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            adminWallet: currentAdmin
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        document.getElementById('totalUsers').textContent = data.users?.length || 0;
                        document.getElementById('totalEvidence').textContent = 'N/A';
                        document.getElementById('totalCases').textContent = 'N/A';
                        return;
                    }
                } catch (error) {
                    console.warn('Backend not available for stats, using localStorage');
                }

                // Fallback to localStorage
                const keys = Object.keys(localStorage);
                const users = keys.filter(key => key.startsWith('evidUser_'));
                document.getElementById('totalUsers').textContent = users.length;
                document.getElementById('totalEvidence').textContent = 'N/A';
                document.getElementById('totalCases').textContent = 'N/A';
            } catch (error) {
                document.getElementById('totalUsers').textContent = 'Error';
                document.getElementById('totalEvidence').textContent = 'Error';
                document.getElementById('totalCases').textContent = 'Error';
            }
        }

        async function deleteUser(walletAddress) {
            if (!confirm('Are you sure you want to delete this user?')) {
                return;
            }

            try {
                localStorage.removeItem(`evidUser_${walletAddress}`);
                showAlert('User deleted successfully', 'success');
                await loadAllUsers();
            } catch (error) {
                showAlert('Error deleting user: ' + error.message, 'error');
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showAlert('Wallet address copied to clipboard!', 'success');
            });
        }

        function formatRole(role) {
            if (!role) return 'Unknown';
            if (typeof role === 'number') {
                const roleMap = {
                    1: 'Public Viewer',
                    2: 'Investigator',
                    3: 'Forensic Analyst',
                    4: 'Legal Professional',
                    5: 'Court Official',
                    6: 'Evidence Manager',
                    7: 'Auditor',
                    8: 'Administrator'
                };
                return roleMap[role] || 'Unknown';
            }
            if (typeof role === 'string') {
                if (role === 'admin') return 'Administrator';
                return role.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            }
            return 'Unknown';
        }

        function getRoleClass(role) {
            if (typeof role === 'number') {
                const classMap = {
                    1: 'public',
                    2: 'investigator',
                    3: 'forensic',
                    4: 'legal',
                    5: 'court',
                    6: 'manager',
                    7: 'auditor',
                    8: 'admin'
                };
                return classMap[role] || 'public';
            }
            const classes = {
                'public_viewer': 'public', 'investigator': 'investigator', 'forensic_analyst': 'forensic',
                'legal_professional': 'legal', 'court_official': 'court', 'evidence_manager': 'manager',
                'auditor': 'auditor', 'admin': 'admin'
            };
            return classes[role] || 'public';
        }

        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;
            alert.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 1000;
                padding: 12px 20px; border-radius: 8px; color: white; font-weight: 500;
                max-width: 400px; background: ${type === 'success' ? '#28a745' : '#dc3545'};
            `;
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        function autoFillWalletAddress() {
            const generateWalletAddress = () => {
                const chars = '0123456789abcdef';
                let result = '0x';
                for (let i = 0; i < 40; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            };

            const walletField = document.getElementById('userWalletAddress');
            if (walletField && !walletField.value) {
                walletField.value = generateWalletAddress();
            }
        }

        function forceRecreateTestAccounts() {
            if (confirm('This will delete and recreate all test accounts. Continue?')) {
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.startsWith('evidUser_0xtest')) {
                        localStorage.removeItem(key);
                    }
                });

                showAlert('Recreating test accounts...', 'info');
                setTimeout(() => createAllTestAccounts(), 1000);
            }
        }

        function resetUserForm() {
            document.getElementById('createUserForm').reset();
        }

        // Role Change Functions
        async function requestRoleChange(targetWallet, currentRole) {
            const roles = ['public_viewer', 'investigator', 'forensic_analyst', 'legal_professional', 'court_official', 'evidence_manager', 'auditor', 'admin'];
            const roleNames = roles.map(r => r.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '));

            let options = roles.map((role, i) =>
                role !== currentRole ? `<option value="${role}">${roleNames[i]}</option>` : ''
            ).join('');

            const newRole = prompt(`Select new role for ${targetWallet.substring(0, 8)}...:\n\n${roleNames.join('\n')}\n\nEnter role:`);
            if (!newRole || !roles.includes(newRole)) return;

            const reason = prompt('Reason for role change (optional):') || '';

            try {
                await window.roleChangeApproval.requestRoleChange(targetWallet, newRole, reason);
                showAlert('Role change request submitted for approval', 'success');
                await loadPendingRoleRequests();
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        }

        async function loadPendingRoleRequests() {
            try {
                const container = document.getElementById('pending-requests');
                if (window.roleChangeApproval && window.roleChangeApproval.renderPendingPanel) {
                    await window.roleChangeApproval.renderPendingPanel(container);
                } else {
                    // Fallback if role change approval system is not loaded
                    container.innerHTML = `
                        <div class="admin-section card">
                            <div class="card-header">
                                <h2>ðŸ“‹ Pending Role Requests</h2>
                                <p>No pending role change requests</p>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">All role changes are processed immediately by administrators.</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading role requests:', error);
                const container = document.getElementById('pending-requests');
                container.innerHTML = `
                    <div class="admin-section card">
                        <div class="card-header">
                            <h2>ðŸ“‹ Pending Role Requests</h2>
                            <p>Error loading requests</p>
                        </div>
                        <div class="card-body">
                            <p class="text-danger">Unable to load role change requests. System may be in maintenance mode.</p>
                        </div>
                    </div>
                `;
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.clear();
                showAlert('Logging out...', 'success');
                setTimeout(() => {
                    window.location.replace('index.html');
                }, 1000);
            }
        }
    </script>
    <script src="footer.js"></script>
</body>

</html>
<style>
    .card-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .action-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .wallet-address {
        font-family: monospace;
        font-size: 0.9em;
        background: #f8f9fa;
        padding: 2px 6px;
        border-radius: 4px;
    }

    .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: 600;
    }

    .status-active {
        background: #d4edda;
        color: #155724;
    }

    .status-inactive {
        background: #f8d7da;
        color: #721c24;
    }

    .badge-admin {
        background: #dc3545;
        color: white;
    }

    .inactive-user {
        opacity: 0.6;
        background: #f8f9fa;
    }

    .btn-sm {
        padding: 4px 8px;
        font-size: 0.8em;
    }

    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        padding: 0;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-body {
        padding: 20px;
    }

    .modal-actions {
        padding: 20px;
        border-top: 1px solid #e5e7eb;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5em;
        cursor: pointer;
        color: #6b7280;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #374151;
    }

    .form-control {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
    }

    .form-control:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
</style>
<style>
    .test-account {
        background: #fff3cd;
        border-left: 3px solid #ffc107;
    }

    .test-account:hover {
        background: #ffeaa7;
    }
</style>