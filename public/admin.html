<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - EVID-DGC</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="config.js"></script>
    <script src="storage.js"></script>
    <script src="simple-notifications.js"></script>
    <script src="indian-apis.js"></script>
</head>
<body>
    <nav class="dashboard-nav">
        <div class="container">
            <div class="nav-content">
                <a href="index.html" class="nav-brand">EVID-DGC Admin</a>
                <div class="nav-items">
                    <span class="badge badge-admin">Administrator</span>
                    <span id="adminWallet" class="wallet-display">Loading...</span>
                    <!-- Notification Bell will be added here by notifications.js -->
                    <button class="btn btn-outline btn-sm" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard-hero">
            <h1>Administrator Dashboard</h1>
            <p>Manage users and system operations</p>
        </div>

        <!-- System Overview -->
        <div class="admin-section card">
            <div class="card-header">
                <h2>System Overview</h2>
                <p>Real-time system statistics</p>
            </div>
            <div class="card-body">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i data-lucide="users"></i></div>
                        <div class="stat-info">
                            <h3 id="totalUsers">0</h3>
                            <p>Total Users</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i data-lucide="file-text"></i></div>
                        <div class="stat-info">
                            <h3 id="totalEvidence">0</h3>
                            <p>Evidence Items</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i data-lucide="folder"></i></div>
                        <div class="stat-info">
                            <h3 id="totalCases">0</h3>
                            <p>Active Cases</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create User -->
        <div class="admin-section card">
            <div class="card-header">
                <h2>Create New User</h2>
                <p>Add a new user account</p>
            </div>
            <div class="card-body">
                <form id="createUserForm" class="admin-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="userWalletAddress">
                                <i data-lucide="wallet"></i>
                                Wallet Address *
                            </label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="userWalletAddress" class="form-control" 
                                       placeholder="0x..." required style="flex: 1;">
                                <button type="button" class="btn btn-outline btn-sm" onclick="autoFillWalletAddress()">
                                    Generate
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="userFirstName">
                                <i data-lucide="user"></i>
                                First Name *
                            </label>
                            <input type="text" id="userFirstName" class="form-control" 
                                   placeholder="Enter first name" required>
                        </div>
                        <div class="form-group">
                            <label for="userLastName">
                                <i data-lucide="user"></i>
                                Last Name *
                            </label>
                            <input type="text" id="userLastName" class="form-control" 
                                   placeholder="Enter last name" required>
                        </div>
                        <div class="form-group">
                            <label for="userEmail">
                                <i data-lucide="mail"></i>
                                Email Address *
                            </label>
                            <input type="email" id="userEmail" class="form-control" 
                                   placeholder="user@example.com" required>
                        </div>
                        <div class="form-group">
                            <label for="userRole">
                                <i data-lucide="users"></i>
                                Role *
                            </label>
                            <select id="userRole" class="form-control" required>
                                <option value="">Select Role</option>
                                <option value="public_viewer">Public Viewer</option>
                                <option value="investigator">Investigator</option>
                                <option value="forensic_analyst">Forensic Analyst</option>
                                <option value="legal_professional">Legal Professional</option>
                                <option value="court_official">Court Official</option>
                                <option value="evidence_manager">Evidence Manager</option>
                                <option value="auditor">Auditor</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="userDepartment">
                                <i data-lucide="building"></i>
                                Department
                            </label>
                            <input type="text" id="userDepartment" class="form-control" 
                                   placeholder="Enter department">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success">
                            <i data-lucide="user-plus"></i>
                            Create User
                        </button>
                        <button type="button" class="btn btn-outline" onclick="resetUserForm()">
                            <i data-lucide="refresh-cw"></i>
                            Reset
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Test Accounts -->
        <div class="admin-section card">
            <div class="card-header">
                <h2>Test Accounts</h2>
                <p>Create and manage test accounts for development</p>
            </div>
            <div class="card-body">
                <div class="admin-form" style="background: #e8f5e8; border: 2px solid #28a745;">
                    <h3>Quick Setup</h3>
                    <p>Create test accounts for all user roles:</p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button id="createAllTestAccounts" class="btn btn-success btn-lg" onclick="createAllTestAccounts()">
                            <i data-lucide="plus"></i>
                            Create All Test Accounts
                        </button>
                        <button class="btn btn-warning" onclick="forceRecreateTestAccounts()">
                            <i data-lucide="refresh-cw"></i>
                            Recreate All
                        </button>
                    </div>
                    <div id="allTestStatus" class="mt-3"></div>
                </div>

                <div class="admin-section" style="margin-top: 30px;">
                    <h3>Role Testing Dashboard</h3>
                    <div id="roleTestingGrid" class="stats-grid">
                        <!-- Will be populated with role cards -->
                    </div>
                </div>
            </div>
        </div>

        <!-- User Management -->
        <div class="admin-section card">
            <div class="card-header">
                <h2>User Management</h2>
                <p>View and manage all system users</p>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <button class="btn btn-outline" onclick="loadAllUsers()">
                        <i data-lucide="refresh-cw"></i>
                        Refresh Users
                    </button>
                    <span id="userCount" class="ml-4 text-muted">Loading...</span>
                </div>
                
                <div class="table-container">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Wallet Address</th>
                                <th>Name</th>
                                <th>Role</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="7" class="text-center">Loading users...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentAdmin = null;

        document.addEventListener('DOMContentLoaded', async function() {
            lucide.createIcons();
            await checkAdminAuth();
            await createDefaultTestAccounts();
            await loadSystemOverview();
            await loadAllUsers();
            await loadRoleTestingDashboard();
            initializeEventListeners();
            
            // Test notification after everything loads
            setTimeout(() => {
                if (window.simpleNotifications) {
                    window.simpleNotifications.addNotification(
                        'Admin Dashboard Ready',
                        'All systems operational!',
                        'system'
                    );
                }
            }, 2000);
        });

        async function createDefaultTestAccounts() {
            const testRoles = [
                { role: 'public_viewer', name: 'Test Public Viewer' },
                { role: 'investigator', name: 'Test Investigator' },
                { role: 'forensic_analyst', name: 'Test Forensic Analyst' },
                { role: 'legal_professional', name: 'Test Legal Professional' },
                { role: 'court_official', name: 'Test Court Official' },
                { role: 'evidence_manager', name: 'Test Evidence Manager' },
                { role: 'auditor', name: 'Test Auditor' }
            ];

            testRoles.forEach((testRole, index) => {
                const testWallet = `0xtest${testRole.role}${(1000 + index).toString()}`;
                const existingKey = `evidUser_${testWallet}`;
                
                const existingTest = Object.keys(localStorage)
                    .filter(key => key.startsWith('evidUser_0xtest'))
                    .find(key => {
                        try {
                            const userData = JSON.parse(localStorage.getItem(key));
                            return userData.role === testRole.role && userData.fullName === testRole.name;
                        } catch (e) {
                            return false;
                        }
                    });
                
                if (!existingTest) {
                    const testUserData = {
                        walletAddress: testWallet,
                        fullName: testRole.name,
                        firstName: 'Test',
                        lastName: testRole.name.replace('Test ', ''),
                        email: `${testRole.role}@test.com`,
                        role: testRole.role,
                        department: 'Test Department',
                        accountType: 'test',
                        isRegistered: true,
                        registrationDate: new Date().toISOString(),
                        createdBy: currentAdmin
                    };
                    localStorage.setItem(existingKey, JSON.stringify(testUserData));
                }
            });
            
            await loadRoleTestingDashboard();
        }

        async function createAllTestAccounts() {
            const button = document.getElementById('createAllTestAccounts');
            const status = document.getElementById('allTestStatus');
            
            button.disabled = true;
            button.innerHTML = '<i data-lucide="loader"></i> Creating...';
            
            const testRoles = [
                { role: 'public_viewer', name: 'Test Public Viewer' },
                { role: 'investigator', name: 'Test Investigator' },
                { role: 'forensic_analyst', name: 'Test Forensic Analyst' },
                { role: 'legal_professional', name: 'Test Legal Professional' },
                { role: 'court_official', name: 'Test Court Official' },
                { role: 'evidence_manager', name: 'Test Evidence Manager' },
                { role: 'auditor', name: 'Test Auditor' }
            ];
            
            let created = 0;
            
            testRoles.forEach((testRole, index) => {
                const testWallet = `0xtest${testRole.role}${1000 + index}`;
                const existingTest = localStorage.getItem(`evidUser_${testWallet}`);
                
                if (!existingTest) {
                    const testUserData = {
                        walletAddress: testWallet,
                        fullName: testRole.name,
                        firstName: 'Test',
                        lastName: testRole.name.replace('Test ', ''),
                        email: `${testRole.role}@test.com`,
                        role: testRole.role,
                        department: 'Test Department',
                        accountType: 'test',
                        isRegistered: true,
                        registrationDate: new Date().toISOString(),
                        createdBy: currentAdmin
                    };
                    localStorage.setItem(`evidUser_${testWallet}`, JSON.stringify(testUserData));
                    created++;
                }
            });
                
            status.innerHTML = `<div class="alert alert-success">Created ${created} test accounts</div>`;
            
            await loadRoleTestingDashboard();
            await loadAllUsers();
            
            setTimeout(() => status.innerHTML = '', 3000);
            button.disabled = false;
            button.innerHTML = '<i data-lucide="plus"></i> Create All Test Accounts';
            lucide.createIcons();
        }
        
        async function loadRoleTestingDashboard() {
            const testRoles = [
                { role: 'public_viewer', name: 'Public Viewer', icon: 'eye', description: 'View public cases' },
                { role: 'investigator', name: 'Investigator', icon: 'search', description: 'Create investigations' },
                { role: 'forensic_analyst', name: 'Forensic Analyst', icon: 'microscope', description: 'Analyze evidence' },
                { role: 'legal_professional', name: 'Legal Professional', icon: 'scale', description: 'Legal review' },
                { role: 'court_official', name: 'Court Official', icon: 'building', description: 'Court proceedings' },
                { role: 'evidence_manager', name: 'Evidence Manager', icon: 'clipboard-list', description: 'Manage evidence' },
                { role: 'auditor', name: 'Auditor', icon: 'audit', description: 'System auditing' }
            ];
            
            const testAccounts = Object.keys(localStorage)
                .filter(key => key.startsWith('evidUser_0xtest'))
                .map(key => {
                    try {
                        const userData = JSON.parse(localStorage.getItem(key));
                        return {
                            wallet_address: userData.walletAddress,
                            role: userData.role
                        };
                    } catch (e) {
                        return null;
                    }
                })
                .filter(account => account !== null);
                
            const grid = document.getElementById('roleTestingGrid');
            
            grid.innerHTML = testRoles.map(role => {
                const account = testAccounts.find(acc => acc.role === role.role);
                const hasAccount = !!account;
                
                return `
                    <div class="stat-card ${hasAccount ? 'test-ready' : 'test-missing'}" style="${hasAccount ? 'border: 2px solid #28a745;' : 'border: 2px solid #ffc107;'}">
                        <div class="stat-icon"><i data-lucide="${role.icon}"></i></div>
                        <div class="stat-info">
                            <h4>${role.name}</h4>
                            <p>${role.description}</p>
                            ${hasAccount ? 
                                `<button class="btn btn-sm btn-success" onclick="testRoleInterface('${account.wallet_address}', '${role.name}')">
                                    <i data-lucide="play"></i> Test Interface
                                </button>
                                <button class="btn btn-sm btn-outline" onclick="copyToClipboard('${account.wallet_address}')">
                                    <i data-lucide="copy"></i> Copy Wallet
                                </button>` :
                                `<button class="btn btn-sm btn-warning" onclick="createSingleTestAccount('${role.role}', 'Test ${role.name}')">
                                    <i data-lucide="plus"></i> Create Account
                                </button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }
        
        async function createSingleTestAccount(role, name) {
            const testWallet = `0xtest${role}${Math.random().toString(36).substring(2, 8)}`;
            const testUserData = {
                walletAddress: testWallet,
                fullName: name,
                role: role,
                department: 'Test Department',
                accountType: 'test',
                isRegistered: true,
                registrationDate: new Date().toISOString(),
                createdBy: currentAdmin
            };
            
            localStorage.setItem(`evidUser_${testWallet}`, JSON.stringify(testUserData));
            showAlert(`Test account created for ${name}!`, 'success');
            await loadRoleTestingDashboard();
            await loadAllUsers();
        }
        
        function testRoleInterface(walletAddress, roleName) {
            try {
                let testUserData = localStorage.getItem('evidUser_' + walletAddress);
                
                if (!testUserData) {
                    showAlert('Test user data not found. Please recreate test accounts.', 'error');
                    return;
                }
                
                testUserData = JSON.parse(testUserData);
                
                localStorage.removeItem('currentUser');
                localStorage.removeItem('testUserMode');
                localStorage.removeItem('testUserName');
                
                localStorage.setItem('currentUser', walletAddress);
                localStorage.setItem('testUserMode', 'true');
                localStorage.setItem('testUserName', roleName);
                
                showAlert(`Testing ${roleName} interface...`, 'success');
                
                setTimeout(() => {
                    window.open('dashboard.html', '_blank');
                }, 1000);
                
            } catch (error) {
                showAlert('Error testing interface: ' + error.message, 'error');
            }
        }

        async function checkAdminAuth() {
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                window.location.href = 'index.html';
                return;
            }

            try {
                let userData;
                if (currentUser.startsWith('email_')) {
                    userData = JSON.parse(localStorage.getItem('evidUser_' + currentUser) || '{}');
                } else {
                    userData = JSON.parse(localStorage.getItem('evidUser_' + currentUser) || '{}');
                }
                
                const isAdmin = userData.role === 8 || userData.role === 'admin' || userData.accountType === 'admin';
                
                if (!isAdmin) {
                    alert('Access denied. Administrator privileges required.');
                    window.location.href = 'index.html';
                    return;
                }

                currentAdmin = currentUser;
                const displayWallet = currentUser.startsWith('email_') ? 'Email Login' : currentUser.substring(0, 8) + '...';
                document.getElementById('adminWallet').textContent = displayWallet;
                
                autoFillWalletAddress();
                
            } catch (error) {
                alert('Access denied. Administrator privileges required.');
                window.location.href = 'index.html';
            }
        }

        function initializeEventListeners() {
            document.getElementById('createUserForm').addEventListener('submit', handleCreateUser);
        }

        async function handleCreateUser(event) {
            event.preventDefault();

            try {
                const walletAddress = document.getElementById('userWalletAddress').value.trim();
                const firstName = document.getElementById('userFirstName').value.trim();
                const lastName = document.getElementById('userLastName').value.trim();
                const email = document.getElementById('userEmail').value.trim();
                const role = document.getElementById('userRole').value;
                const department = document.getElementById('userDepartment').value.trim();

                if (!walletAddress.match(/^0x[a-fA-F0-9]{40}$/)) {
                    throw new Error('Invalid wallet address format');
                }

                if (!role) {
                    throw new Error('Please select a role');
                }

                if (!firstName || !lastName || !email) {
                    throw new Error('Please fill in all required fields');
                }

                const userData = {
                    walletAddress,
                    fullName: `${firstName} ${lastName}`,
                    firstName,
                    lastName,
                    email,
                    role,
                    department: department || 'General',
                    accountType: 'real',
                    isRegistered: true,
                    registrationDate: new Date().toISOString(),
                    createdBy: currentAdmin
                };

                localStorage.setItem(`evidUser_${walletAddress}`, JSON.stringify(userData));

                showAlert('User account created successfully!', 'success');
                document.getElementById('createUserForm').reset();
                await loadAllUsers();
            } catch (error) {
                showAlert('Error creating user: ' + error.message, 'error');
            }
        }

        async function loadAllUsers() {
            try {
                const keys = Object.keys(localStorage);
                const users = keys
                    .filter(key => key.startsWith('evidUser_'))
                    .map(key => {
                        const userData = JSON.parse(localStorage.getItem(key));
                        return {
                            wallet_address: userData.walletAddress,
                            full_name: userData.fullName,
                            role: userData.role,
                            account_type: userData.accountType || 'real',
                            is_active: true,
                            created_at: userData.registrationDate || new Date().toISOString()
                        };
                    });

                const tbody = document.getElementById('usersTableBody');
                const userCount = document.getElementById('userCount');

                userCount.textContent = `Total Users: ${users.length}`;

                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">No users found</td></tr>';
                    return;
                }

                tbody.innerHTML = users.map(user => `
                    <tr class="${user.account_type === 'test' ? 'test-account' : ''} ${!user.is_active ? 'inactive-user' : ''}">
                        <td class="test-wallet">${user.wallet_address}</td>
                        <td>${user.full_name}</td>
                        <td><span class="badge badge-${getRoleClass(user.role)}">${formatRole(user.role)}</span></td>
                        <td>${user.account_type === 'test' ? 'Test' : 'Real'}</td>
                        <td>${user.is_active ? 'Active' : 'Inactive'}</td>
                        <td>${new Date(user.created_at).toLocaleDateString()}</td>
                        <td>
                            ${user.is_active && user.wallet_address !== currentAdmin ?
                                `<button class="btn btn-sm btn-danger" onclick="deleteUser('${user.wallet_address}')">Delete</button>` :
                                user.wallet_address === currentAdmin ? '<span class="text-muted">Self</span>' : '<span class="text-muted">Deleted</span>'
                            }
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                showAlert('Error loading users: ' + error.message, 'error');
            }
        }

        async function loadSystemOverview() {
            try {
                const keys = Object.keys(localStorage);
                const users = keys.filter(key => key.startsWith('evidUser_'));
                document.getElementById('totalUsers').textContent = users.length;
                document.getElementById('totalEvidence').textContent = 'N/A';
                document.getElementById('totalCases').textContent = 'N/A';
            } catch (error) {
                document.getElementById('totalUsers').textContent = 'N/A';
                document.getElementById('totalEvidence').textContent = 'N/A';
                document.getElementById('totalCases').textContent = 'N/A';
            }
        }

        async function deleteUser(walletAddress) {
            if (!confirm('Are you sure you want to delete this user?')) {
                return;
            }

            try {
                localStorage.removeItem(`evidUser_${walletAddress}`);
                showAlert('User deleted successfully', 'success');
                await loadAllUsers();
            } catch (error) {
                showAlert('Error deleting user: ' + error.message, 'error');
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showAlert('Wallet address copied to clipboard!', 'success');
            });
        }

        function formatRole(role) {
            return role.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }

        function getRoleClass(role) {
            const classes = {
                'public_viewer': 'public', 'investigator': 'investigator', 'forensic_analyst': 'forensic',
                'legal_professional': 'legal', 'court_official': 'court', 'evidence_manager': 'manager',
                'auditor': 'auditor', 'admin': 'admin'
            };
            return classes[role] || 'public';
        }

        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;
            alert.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 1000;
                padding: 12px 20px; border-radius: 8px; color: white; font-weight: 500;
                max-width: 400px; background: ${type === 'success' ? '#28a745' : '#dc3545'};
            `;
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }
        
        function autoFillWalletAddress() {
            const generateWalletAddress = () => {
                const chars = '0123456789abcdef';
                let result = '0x';
                for (let i = 0; i < 40; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            };
            
            const walletField = document.getElementById('userWalletAddress');
            if (walletField && !walletField.value) {
                walletField.value = generateWalletAddress();
            }
        }
        
        function forceRecreateTestAccounts() {
            if (confirm('This will delete and recreate all test accounts. Continue?')) {
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.startsWith('evidUser_0xtest')) {
                        localStorage.removeItem(key);
                    }
                });
                
                showAlert('Recreating test accounts...', 'info');
                setTimeout(() => createAllTestAccounts(), 1000);
            }
        }
        
        function resetUserForm() {
            document.getElementById('createUserForm').reset();
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.clear();
                showAlert('Logging out...', 'success');
                setTimeout(() => {
                    window.location.replace('index.html');
                }, 1000);
            }
        }
    </script>
</body>
</html>