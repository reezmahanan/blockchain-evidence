<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß System Health Check - EVID-DGC</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .health-check {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
        }
        .check-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            background: var(--white);
            border: 1px solid var(--border-light);
        }
        .check-status {
            font-weight: bold;
            padding: 4px 12px;
            border-radius: 4px;
        }
        .status-pass { background: #d4edda; color: #155724; }
        .status-fail { background: #f8d7da; color: #721c24; }
        .status-loading { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <div class="health-check">
            <h1>üîß EVID-DGC System Health Check</h1>
            <p>Verifying all critical components are functional...</p>
            
            <div id="healthResults">
                <div class="check-item">
                    <span>üìÑ CSS Styles Loading</span>
                    <span class="check-status status-loading" id="css-check">Checking...</span>
                </div>
                <div class="check-item">
                    <span>‚öôÔ∏è Configuration File</span>
                    <span class="check-status status-loading" id="config-check">Checking...</span>
                </div>
                <div class="check-item">
                    <span>üíæ Supabase Storage</span>
                    <span class="check-status status-loading" id="storage-check">Checking...</span>
                </div>
                <div class="check-item">
                    <span>üîê Evidence Manager</span>
                    <span class="check-status status-loading" id="evidence-check">Checking...</span>
                </div>
                <div class="check-item">
                    <span>üåê Web3 Integration</span>
                    <span class="check-status status-loading" id="web3-check">Checking...</span>
                </div>
                <div class="check-item">
                    <span>üìã Dashboard Manager</span>
                    <span class="check-status status-loading" id="dashboard-check">Checking...</span>
                </div>
                <div class="check-item">
                    <span>üîó Database Connection</span>
                    <span class="check-status status-loading" id="db-check">Checking...</span>
                </div>
            </div>
            
            <div id="overallStatus" class="card mt-6">
                <div class="card-body text-center">
                    <h2 id="statusTitle">üîÑ Running Health Checks...</h2>
                    <p id="statusMessage">Please wait while we verify all system components.</p>
                    <div class="loading" id="statusLoader"></div>
                </div>
            </div>
            
            <div class="mt-6 text-center">
                <button class="btn btn-primary" onclick="runHealthCheck()">üîÑ Run Check Again</button>
                <a href="index.html" class="btn btn-outline">üè† Back to Home</a>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <script src="secure-config.js"></script>
    <script src="supabase-storage.js"></script>
    <script src="secure-evidence-manager.js"></script>
    <script src="dashboard-manager.js"></script>
    
    <script>
        let healthResults = {
            css: false,
            config: false,
            storage: false,
            evidence: false,
            web3: false,
            dashboard: false,
            database: false
        };

        async function runHealthCheck() {
            console.log('üîß Starting system health check...');
            
            // Reset all statuses
            Object.keys(healthResults).forEach(key => {
                const element = document.getElementById(key + '-check');
                if (element) {
                    element.textContent = 'Checking...';
                    element.className = 'check-status status-loading';
                }
            });
            
            // Show loading
            document.getElementById('statusLoader').style.display = 'block';
            document.getElementById('statusTitle').textContent = 'üîÑ Running Health Checks...';
            document.getElementById('statusMessage').textContent = 'Please wait while we verify all system components.';
            
            // Check CSS
            await checkCSS();
            
            // Check Configuration
            await checkConfig();
            
            // Check Storage
            await checkStorage();
            
            // Check Evidence Manager
            await checkEvidenceManager();
            
            // Check Web3
            await checkWeb3();
            
            // Check Dashboard Manager
            await checkDashboardManager();
            
            // Check Database
            await checkDatabase();
            
            // Show final results
            showFinalResults();
        }

        async function checkCSS() {
            try {
                // Check if CSS variables are loaded
                const testElement = document.createElement('div');
                testElement.style.color = 'var(--primary-red)';
                document.body.appendChild(testElement);
                const computedStyle = window.getComputedStyle(testElement);
                const hasCSS = computedStyle.color !== 'var(--primary-red)';
                document.body.removeChild(testElement);
                
                updateStatus('css', hasCSS, hasCSS ? 'Loaded' : 'Failed');
            } catch (error) {
                updateStatus('css', false, 'Error');
            }
        }

        async function checkConfig() {
            try {
                const hasConfig = typeof config !== 'undefined' && config.SUPABASE_URL;
                updateStatus('config', hasConfig, hasConfig ? 'Loaded' : 'Missing');
            } catch (error) {
                updateStatus('config', false, 'Error');
            }
        }

        async function checkStorage() {
            try {
                const hasStorage = typeof storage !== 'undefined' && typeof storage.init === 'function';
                updateStatus('storage', hasStorage, hasStorage ? 'Ready' : 'Missing');
            } catch (error) {
                updateStatus('storage', false, 'Error');
            }
        }

        async function checkEvidenceManager() {
            try {
                const hasManager = typeof secureEvidenceManager !== 'undefined';
                updateStatus('evidence', hasManager, hasManager ? 'Ready' : 'Missing');
            } catch (error) {
                updateStatus('evidence', false, 'Error');
            }
        }

        async function checkWeb3() {
            try {
                const hasWeb3 = typeof Web3 !== 'undefined';
                updateStatus('web3', hasWeb3, hasWeb3 ? 'Available' : 'Missing');
            } catch (error) {
                updateStatus('web3', false, 'Error');
            }
        }

        async function checkDashboardManager() {
            try {
                const hasManager = typeof DashboardManager !== 'undefined';
                updateStatus('dashboard', hasManager, hasManager ? 'Ready' : 'Missing');
            } catch (error) {
                updateStatus('dashboard', false, 'Error');
            }
        }

        async function checkDatabase() {
            try {
                if (typeof storage !== 'undefined' && storage.supabaseUrl) {
                    // Test connection
                    const response = await fetch(storage.supabaseUrl + '/rest/v1/', {
                        method: 'HEAD',
                        headers: { 'apikey': storage.supabaseKey }
                    });
                    const connected = response.ok;
                    updateStatus('database', connected, connected ? 'Connected' : 'Failed');
                } else {
                    updateStatus('database', false, 'No Config');
                }
            } catch (error) {
                updateStatus('database', false, 'Error');
            }
        }

        function updateStatus(component, success, message) {
            healthResults[component] = success;
            const element = document.getElementById(component + '-check');
            if (element) {
                element.textContent = message;
                element.className = `check-status ${success ? 'status-pass' : 'status-fail'}`;
            }
        }

        function showFinalResults() {
            const totalChecks = Object.keys(healthResults).length;
            const passedChecks = Object.values(healthResults).filter(Boolean).length;
            const allPassed = passedChecks === totalChecks;
            
            document.getElementById('statusLoader').style.display = 'none';
            
            if (allPassed) {
                document.getElementById('statusTitle').textContent = '‚úÖ All Systems Operational';
                document.getElementById('statusMessage').textContent = 
                    `Perfect! All ${totalChecks} components are working correctly. The system is ready for production use.`;
            } else {
                document.getElementById('statusTitle').textContent = '‚ö†Ô∏è Some Issues Detected';
                document.getElementById('statusMessage').textContent = 
                    `${passedChecks}/${totalChecks} components are working. Please check the failed components above.`;
            }
            
            console.log('üîß Health check completed:', healthResults);
        }

        // Auto-run health check on page load
        document.addEventListener('DOMContentLoaded', runHealthCheck);
    </script>
</body>
</html>