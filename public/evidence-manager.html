<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Premium SEO & Meta -->
    <title>EVID-DGC ¬∑ Blockchain Evidence Vault</title>
    <meta name="description" content="Secure blockchain evidence upload and verification - Immutable chain of custody">
    <meta name="theme-color" content="#d32f2f">
    
    <!-- Critical CSS -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="responsive-improvements.css">
    
    <!-- Favicon Suite -->
    <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    
    <!-- Premium Font Loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons - Pinned to specific version with Subresource Integrity -->
    <script src="https://unpkg.com/lucide@0.344.0" integrity="sha384-Kl3cQhNN0eOsiHm8vPcqgY72Lp6P/9GPQOJGfQnN/zTbtFTl4tYxQ+UqIsb0m0Y0" crossorigin="anonymous"></script>
    
    <!-- Web3.js for Blockchain Integration -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
</head>

<body>
    <!-- Navigation -->
    <nav class="header-nav">
        <div class="navbar-container">
            <a href="index.html" class="nav-brand">
                <img src="logo-32x32.png" alt="EVID-DGC Logo" class="brand-logo">
                <span>EVID-DGC</span>
            </a>
            <div class="nav-items">
                <a href="dashboard.html" class="nav-link">Dashboard</a>
                <a href="cases.html" class="nav-link">Cases</a>
                <a href="evidence-manager.html" class="nav-link" style="color: var(--primary-red); background: var(--evidence-red-soft);">Evidence Vault</a>
            </div>
        </div>
    </nav>

    <!-- ===== PREMIUM EVIDENCE HERO ===== -->
    <div class="evidence-hero">
        <div class="hero-content">
            <div class="hero-badge">
                <i data-lucide="shield"></i>
                <span>Blockchain Evidence Vault ‚Ä¢ Immutable Storage</span>
            </div>
            <h1>
                <span class="hero-highlight">Secure Evidence</span><br>
                Upload & Verification
            </h1>
            <p class="hero-subtitle">
                Upload evidence with SHA-256 hashing and blockchain timestamping. 
                Every file becomes an immutable record with full chain of custody.
            </p>
        </div>
    </div>

    <!-- ===== PREMIUM BLOCKCHAIN STATUS ===== -->
    <div class="blockchain-status-bar">
        <div class="status-grid">
            <div class="status-item">
                <div class="status-icon success">
                    <i data-lucide="link-2"></i>
                </div>
                <div class="status-info">
                    <span class="status-label">Network Status</span>
                    <span class="status-value" id="networkStatus">Ethereum Mainnet</span>
                </div>
            </div>
            <div class="status-item">
                <div class="status-icon">
                    <i data-lucide="layers"></i>
                </div>
                <div class="status-info">
                    <span class="status-label">Block Height</span>
                    <span class="status-value mono" id="blockHeight">19,423,856</span>
                </div>
            </div>
            <div class="status-item">
                <div class="status-icon">
                    <i data-lucide="fuel"></i>
                </div>
                <div class="status-info">
                    <span class="status-label">Gas Price</span>
                    <span class="status-value" id="gasPrice">24 Gwei</span>
                </div>
            </div>
            <div class="status-item">
                <div class="status-icon success">
                    <i data-lucide="check-circle"></i>
                </div>
                <div class="status-info">
                    <span class="status-label">Contract Status</span>
                    <span class="status-value" id="contractStatus">Verified</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== PREMIUM UPLOAD SECTION ===== -->
    <div class="upload-section">
        <div class="upload-card">
            <div class="upload-header">
                <h2>
                    <i data-lucide="upload-cloud"></i>
                    Upload New Evidence
                </h2>
                <div class="network-badge">
                    <i data-lucide="shield"></i>
                    Blockchain Secured
                </div>
            </div>
            
            <!-- Premium Drop Zone -->
            <div id="dropZone" class="drop-zone" onclick="document.getElementById('evidenceFile').click()">
                <div class="drop-zone-icon">
                    <i data-lucide="upload"></i>
                </div>
                <h3>Drag & Drop Evidence File</h3>
                <p>or click to browse from computer</p>
                <div class="file-types">
                    <span class="file-type-badge">PDF</span>
                    <span class="file-type-badge">JPG/PNG</span>
                    <span class="file-type-badge">MP4/MOV</span>
                    <span class="file-type-badge">MP3/WAV</span>
                    <span class="file-type-badge">DOC/DOCX</span>
                    <span class="file-type-badge">ZIP/RAR</span>
                </div>
            </div>
            <input type="file" id="evidenceFile" style="display: none;" onchange="handleFileSelect(this.files[0])">
            
            <!-- Upload Progress -->
            <div id="uploadProgress" class="upload-progress">
                <div class="progress-header">
                    <span class="progress-title">
                        <i data-lucide="hard-drive"></i>
                        <span id="uploadFileName">evidence_file.pdf</span>
                    </span>
                    <span class="progress-percentage" id="uploadPercentage">0%</span>
                </div>
                <div class="progress-bar-premium">
                    <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                </div>
                <div class="progress-status">
                    <i data-lucide="clock"></i>
                    <span id="uploadStatus">Ready to upload</span>
                </div>
            </div>
            
            <!-- Evidence Form -->
            <form id="evidenceForm">
                <div class="form-grid-premium">
                    <div class="form-group-premium">
                        <label class="form-label">
                            <i data-lucide="hash"></i>
                            Case ID *
                        </label>
                        <input type="text" id="caseId" class="form-control-premium" placeholder="e.g., INV-2024-001" required>
                    </div>
                    
                    <div class="form-group-premium">
                        <label class="form-label">
                            <i data-lucide="tag"></i>
                            Evidence Type *
                        </label>
                        <select id="evidenceType" class="form-control-premium" required>
                            <option value="" disabled selected>Select evidence type</option>
                            <option value="document">üìÑ Document</option>
                            <option value="image">üñºÔ∏è Image/Photo</option>
                            <option value="video">üé• Video</option>
                            <option value="audio">üéµ Audio</option>
                            <option value="digital">üíæ Digital File</option>
                            <option value="physical">üì¶ Physical Item</option>
                        </select>
                    </div>
                    
                    <div class="form-group-premium full-width">
                        <label class="form-label">
                            <i data-lucide="file-text"></i>
                            Description *
                        </label>
                        <textarea id="description" class="form-control-premium" rows="3" placeholder="Provide detailed description of the evidence" required></textarea>
                    </div>
                    
                    <div class="form-group-premium">
                        <label class="form-label">
                            <i data-lucide="map-pin"></i>
                            Collection Location
                        </label>
                        <input type="text" id="location" class="form-control-premium" placeholder="Where was this collected?">
                    </div>
                    
                    <div class="form-group-premium">
                        <label class="form-label">
                            <i data-lucide="calendar"></i>
                            Collection Date
                        </label>
                        <input type="datetime-local" id="collectionDate" class="form-control-premium">
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="resetForm()">
                        <i data-lucide="x"></i>
                        Clear Form
                    </button>
                    <button type="submit" class="btn btn-primary pulse-animation" id="uploadSubmitBtn">
                        <i data-lucide="shield"></i>
                        Upload & Hash to Blockchain
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ===== PREMIUM EVIDENCE INVENTORY ===== -->
    <div class="evidence-grid-section">
        <div class="evidence-header">
            <h2>
                <i data-lucide="archive"></i>
                Evidence Inventory
            </h2>
            <div class="evidence-search">
                <div class="evidence-search-input">
                    <i data-lucide="search"></i>
                    <input type="text" id="searchEvidence" placeholder="Search evidence..." onkeyup="filterEvidence()">
                </div>
                <button class="btn btn-outline btn-sm" onclick="refreshEvidence()">
                    <i data-lucide="refresh-cw"></i>
                    Sync
                </button>
            </div>
        </div>
        
        <div id="evidenceGridContainer" class="evidence-grid-premium">
            <!-- Evidence cards will be dynamically inserted here -->
        </div>
    </div>

    <!-- ===== PREMIUM CHAIN OF CUSTODY MODAL ===== -->
    <div id="custodyModal" class="custody-modal">
        <div class="custody-modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="font-size: 24px; font-weight: 700; color: var(--evidence-gray-900); display: flex; align-items: center; gap: 12px;">
                    <i data-lucide="link-2" style="width: 24px; height: 24px; color: var(--evidence-red);"></i>
                    Chain of Custody
                </h2>
                <button onclick="closeCustodyModal()" style="background: none; border: none; cursor: pointer; padding: 8px;">
                    <i data-lucide="x" style="width: 20px; height: 20px; color: var(--evidence-gray-500);"></i>
                </button>
            </div>
            <div id="custodyContent">
                <!-- Dynamic custody timeline will be inserted here -->
            </div>
        </div>
    </div>

    <!-- ===== PREMIUM EVIDENCE DETAIL MODAL ===== -->
    <div id="evidenceDetailModal" class="custody-modal">
        <div class="custody-modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="font-size: 24px; font-weight: 700; color: var(--evidence-gray-900);" id="detailModalTitle">
                    Evidence Details
                </h2>
                <button onclick="closeDetailModal()" style="background: none; border: none; cursor: pointer; padding: 8px;">
                    <i data-lucide="x" style="width: 20px; height: 20px; color: var(--evidence-gray-500);"></i>
                </button>
            </div>
            <div id="detailModalContent">
                <!-- Dynamic evidence details will be inserted here -->
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="storage.js"></script>
    
    <script>
        // ===== PREMIUM BLOCKCHAIN EVIDENCE VAULT =====
        // Strict Red & White Theme - Blockchain Integration
        
        let currentUser = null;
        let evidenceList = [];
        let web3 = null;
        let currentFile = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Lucide icons
            lucide.createIcons();
            // Initialize evidence vault
            initializeEvidenceVault();
            // Setup drag & drop
            setupDragAndDrop();
            // Simulate blockchain connection
            initializeBlockchain();
        });
        
        // HTML escaping function to prevent XSS
        function escapeHtml(value) {
            if (value === undefined || value === null) return '';
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        
        // Safe JSON parse helper function
        function safeJsonParse(jsonString, defaultValue, isArray = false) {
            if (!jsonString) return defaultValue;
            
            try {
                const parsed = JSON.parse(jsonString);
                
                // Validate based on expected type
                if (isArray && !Array.isArray(parsed)) {
                    console.warn('Expected array but got:', typeof parsed);
                    return defaultValue;
                }
                
                if (!isArray && (typeof parsed !== 'object' || parsed === null)) {
                    console.warn('Expected object but got:', typeof parsed);
                    return defaultValue;
                }
                
                return parsed;
            } catch (e) {
                console.error('JSON parse error:', e);
                return defaultValue;
            }
        }
        
        async function initializeEvidenceVault() {
            try {
                // Check authentication
                const userAccount = localStorage.getItem('currentUser');
                if (!userAccount) {
                    window.location.href = 'index.html';
                    return;
                }
                
                // Load user data with error handling
                let userData = {};
                try {
                    const storedUser = localStorage.getItem('evidUser_' + userAccount);
                    if (storedUser) {
                        userData = safeJsonParse(storedUser, {}, false);
                    }
                } catch (e) {
                    console.error('Error accessing user data:', e);
                }
                
                if (!userData.role) {
                    const selectedRole = localStorage.getItem('selectedRole');
                    if (selectedRole) {
                        userData.role = selectedRole;
                        userData.fullName = localStorage.getItem('testUserName') || 'Evidence Manager';
                        userData.walletAddress = userAccount;
                        
                        try {
                            localStorage.setItem('evidUser_' + userAccount, JSON.stringify(userData));
                        } catch (e) {
                            console.error('Failed to save user data:', e);
                        }
                    }
                }
                
                currentUser = userData;
                
                // Load evidence from localStorage
                loadEvidence();
                
                // Setup form submit handler
                document.getElementById('evidenceForm').addEventListener('submit', handleEvidenceUpload);
                
                // Check URL for case ID parameter
                const urlParams = new URLSearchParams(window.location.search);
                const caseId = urlParams.get('case');
                if (caseId) {
                    document.getElementById('caseId').value = caseId;
                    showNotification(`üìã Case ID ${escapeHtml(caseId)} pre-filled`, 'info');
                }
                
            } catch (error) {
                console.error('Evidence vault initialization error:', error);
                showNotification('Failed to initialize evidence vault', 'error');
            }
        }
        
        function initializeBlockchain() {
            // Simulate blockchain connection
            setTimeout(() => {
                document.getElementById('networkStatus').textContent = 'Ethereum Mainnet';
                document.getElementById('blockHeight').textContent = '19,423,856';
                document.getElementById('gasPrice').textContent = '24 Gwei';
                document.getElementById('contractStatus').textContent = 'Verified';
            }, 1000);
        }
        
        function setupDragAndDrop() {
            const dropZone = document.getElementById('dropZone');
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });
            
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });
        }
        
        function handleFileSelect(file) {
            if (!file) return;
            
            currentFile = file;
            
            // Show progress section
            const progressSection = document.getElementById('uploadProgress');
            progressSection.classList.add('active');
            
            // Update file name
            document.getElementById('uploadFileName').textContent = file.name;
            document.getElementById('uploadStatus').innerHTML = '<i data-lucide="check-circle"></i> File selected, ready to upload';
            
            // Auto-fill description with file name
            if (!document.getElementById('description').value) {
                document.getElementById('description').value = `Evidence file: ${file.name} (${formatFileSize(file.size)})`;
            }
            
            lucide.createIcons();
        }
        
        async function handleEvidenceUpload(event) {
            event.preventDefault();
            
            try {
                // Validate form
                const caseId = document.getElementById('caseId').value;
                const evidenceType = document.getElementById('evidenceType').value;
                const description = document.getElementById('description').value;
                
                if (!caseId) {
                    showNotification('Case ID is required', 'error');
                    return;
                }
                
                if (!evidenceType) {
                    showNotification('Evidence type is required', 'error');
                    return;
                }
                
                if (!description) {
                    showNotification('Description is required', 'error');
                    return;
                }
                
                if (!currentFile) {
                    showNotification('Please select a file to upload', 'error');
                    return;
                }
                
                // Disable submit button
                const submitBtn = document.getElementById('uploadSubmitBtn');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i data-lucide="loader"></i> Processing...';
                lucide.createIcons();
                
                // Simulate upload progress
                await simulateUploadProgress();
                
                // Calculate file hash
                const fileHash = await calculateFileHash(currentFile);
                
                // Simulate blockchain transaction
                const txHash = await simulateBlockchainTransaction();
                
                // Create evidence record
                const evidenceData = {
                    id: 'EVD-' + Date.now(),
                    caseId: caseId,
                    type: evidenceType,
                    description: description,
                    location: document.getElementById('location').value || 'Not specified',
                    collectionDate: document.getElementById('collectionDate').value || new Date().toISOString().split('T')[0],
                    fileName: currentFile.name,
                    fileSize: currentFile.size,
                    fileType: currentFile.type,
                    fileHash: fileHash,
                    blockchainTx: txHash,
                    uploadedBy: currentUser?.fullName || 'Evidence Manager',
                    uploadedAt: new Date().toISOString(),
                    status: 'verified',
                    verified: true,
                    hash: fileHash.substring(0, 16) + '...'
                };
                
                // Save to localStorage with error handling
                const evidenceKey = 'evidence_' + (currentUser?.walletAddress || 'default');
                
                // Safely load existing evidence
                let existingEvidence = [];
                try {
                    const stored = localStorage.getItem(evidenceKey);
                    if (stored) {
                        existingEvidence = safeJsonParse(stored, [], true);
                    }
                } catch (e) {
                    console.error('Error reading evidence from localStorage:', e);
                }
                
                existingEvidence.unshift(evidenceData);
                
                try {
                    localStorage.setItem(evidenceKey, JSON.stringify(existingEvidence));
                } catch (e) {
                    console.error('Failed to save evidence to localStorage:', e);
                    showNotification('Failed to save evidence', 'error');
                    return;
                }
                
                // Also save to global evidence list with error handling
                try {
                    const globalEvidence = safeJsonParse(localStorage.getItem('evidence'), [], true);
                    globalEvidence.unshift(evidenceData);
                    localStorage.setItem('evidence', JSON.stringify(globalEvidence));
                } catch (e) {
                    console.error('Error saving to global evidence:', e);
                }
                
                // Add to case evidence count with error handling
                try {
                    updateCaseEvidenceCount(caseId);
                } catch (e) {
                    console.error('Failed to update case evidence count:', e);
                }
                
                // Reset form
                resetForm();
                
                // Reload evidence grid
                loadEvidence();
                
                // Show success notification
                showNotification('‚úÖ Evidence uploaded and verified on blockchain', 'success');
                
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i data-lucide="shield"></i> Upload & Hash to Blockchain';
                lucide.createIcons();
                
            } catch (error) {
                console.error('Upload error:', error);
                showNotification('Upload failed: ' + error.message, 'error');
                
                // Re-enable submit button
                const submitBtn = document.getElementById('uploadSubmitBtn');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i data-lucide="shield"></i> Upload & Hash to Blockchain';
                lucide.createIcons();
            }
        }
        
        function simulateUploadProgress() {
            return new Promise((resolve) => {
                const progressFill = document.getElementById('progressFill');
                const percentageEl = document.getElementById('uploadPercentage');
                const statusEl = document.getElementById('uploadStatus');
                
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 5;
                    progressFill.style.width = progress + '%';
                    percentageEl.textContent = progress + '%';
                    
                    if (progress === 30) {
                        statusEl.innerHTML = '<i data-lucide="hash"></i> Calculating SHA-256 hash...';
                    } else if (progress === 60) {
                        statusEl.innerHTML = '<i data-lucide="link-2"></i> Submitting to blockchain...';
                    } else if (progress === 90) {
                        statusEl.innerHTML = '<i data-lucide="check-circle"></i> Verifying transaction...';
                    }
                    
                    lucide.createIcons();
                    
                    if (progress >= 100) {
                        clearInterval(interval);
                        setTimeout(resolve, 500);
                    }
                }, 100);
            });
        }
        
        async function calculateFileHash(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const buffer = e.target.result;
                    const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                    resolve(hashHex);
                };
                reader.readAsArrayBuffer(file);
            });
        }
        
        function simulateBlockchainTransaction() {
            return new Promise((resolve) => {
                setTimeout(() => {
                    resolve('0x' + Math.random().toString(16).substr(2, 64));
                }, 1500);
            });
        }
        
        function updateCaseEvidenceCount(caseId) {
            try {
                const cases = safeJsonParse(localStorage.getItem('cases'), [], true);
                const caseIndex = cases.findIndex(c => c.id === caseId);
                
                if (caseIndex !== -1) {
                    cases[caseIndex].evidenceCount = (cases[caseIndex].evidenceCount || 0) + 1;
                    localStorage.setItem('cases', JSON.stringify(cases));
                }
            } catch (e) {
                console.error('Failed to update case evidence count:', e);
            }
        }
        
        function loadEvidence() {
            const evidenceKey = 'evidence_' + (currentUser?.walletAddress || 'default');
            
            try {
                const stored = localStorage.getItem(evidenceKey);
                if (stored) {
                    evidenceList = safeJsonParse(stored, [], true);
                } else {
                    // Load mock data for demonstration
                    evidenceList = getMockEvidenceData();
                }
            } catch (e) {
                console.error('Error loading evidence:', e);
                evidenceList = getMockEvidenceData();
            }
            
            renderEvidenceGrid(evidenceList);
        }
        
        function getMockEvidenceData() {
            return [
                {
                    id: 'EVD-20240315-001',
                    caseId: 'INV-2024-001',
                    fileName: 'security_footage.mp4',
                    type: 'video',
                    fileSize: 15728640,
                    uploadedBy: 'Det. Johnson',
                    uploadedAt: '2024-03-15T10:30:00Z',
                    status: 'verified',
                    verified: true,
                    hash: '7d3a...f9b2',
                    blockchainTx: '0x7d3a...f9b2',
                    description: 'Security camera footage from downtown office building'
                },
                {
                    id: 'EVD-20240314-002',
                    caseId: 'INV-2024-001',
                    fileName: 'fingerprint_lift_001.jpg',
                    type: 'image',
                    fileSize: 2457600,
                    uploadedBy: 'Det. Johnson',
                    uploadedAt: '2024-03-14T14:20:00Z',
                    status: 'verified',
                    verified: true,
                    hash: '8e4c...a1d3',
                    blockchainTx: '0x8e4c...a1d3',
                    description: 'Latent fingerprint lifted from door handle'
                },
                {
                    id: 'EVD-20240313-003',
                    caseId: 'INV-2024-002',
                    fileName: 'financial_records.pdf',
                    type: 'document',
                    fileSize: 3145728,
                    uploadedBy: 'Det. Smith',
                    uploadedAt: '2024-03-13T09:15:00Z',
                    status: 'verified',
                    verified: true,
                    hash: '2b5f...c7e8',
                    blockchainTx: '0x2b5f...c7e8',
                    description: 'Suspicious transaction records'
                }
            ];
        }
        
        function renderEvidenceGrid(evidence) {
            const container = document.getElementById('evidenceGridContainer');
            
            if (evidence.length === 0) {
                container.innerHTML = `
                    <div class="evidence-empty-state">
                        <div class="evidence-empty-icon">
                            <i data-lucide="archive"></i>
                        </div>
                        <h3>No evidence uploaded yet</h3>
                        <p>Upload your first evidence file to secure it on the blockchain</p>
                        <button class="btn btn-primary" onclick="document.getElementById('dropZone').click()">
                            <i data-lucide="upload"></i>
                            Upload Evidence
                        </button>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            // Build HTML with escaped values
            container.innerHTML = evidence.map(item => {
                // Escape all user-provided content
                const escapedId = escapeHtml(item.id);
                const escapedCaseId = escapeHtml(item.caseId);
                const escapedFileName = escapeHtml(truncateFileName(item.fileName));
                const escapedUploadedBy = escapeHtml(item.uploadedBy);
                const escapedDate = escapeHtml(formatDate(item.uploadedAt));
                const escapedFileSize = escapeHtml(formatFileSize(item.fileSize));
                const escapedType = escapeHtml(capitalizeFirst(item.type));
                
                // Fix: Properly handle hash fallback without "undefined..." bug
                let hashDisplay = 'N/A';
                if (item.hash) {
                    hashDisplay = item.hash;
                } else if (item.fileHash) {
                    hashDisplay = item.fileHash.substring(0, 16) + '...';
                }
                const escapedHash = escapeHtml(hashDisplay);
                
                const iconName = getEvidenceIcon(item.type);
                const statusIcon = item.status === 'verified' ? 'shield' : 'clock';
                const statusText = item.status === 'verified' ? 'VERIFIED' : 'PENDING';
                
                return `
                    <div class="evidence-vault-card" onclick="viewEvidenceDetails('${escapedId}')">
                        <div class="evidence-card-header">
                            <div class="evidence-type-icon">
                                <i data-lucide="${iconName}"></i>
                            </div>
                            <span class="evidence-status-badge ${item.status}">
                                <i data-lucide="${statusIcon}"></i>
                                ${statusText}
                            </span>
                        </div>
                        
                        <h3 class="evidence-file-name">${escapedFileName}</h3>
                        <div class="evidence-case-id">
                            <i data-lucide="hash"></i>
                            ${escapedCaseId}
                        </div>
                        
                        <div class="evidence-metadata">
                            <div class="evidence-meta-item">
                                <span class="evidence-meta-label">
                                    <i data-lucide="user"></i>
                                    Uploaded By
                                </span>
                                <span class="evidence-meta-value">${escapedUploadedBy}</span>
                            </div>
                            <div class="evidence-meta-item">
                                <span class="evidence-meta-label">
                                    <i data-lucide="calendar"></i>
                                    Date
                                </span>
                                <span class="evidence-meta-value">${escapedDate}</span>
                            </div>
                            <div class="evidence-meta-item">
                                <span class="evidence-meta-label">
                                    <i data-lucide="hard-drive"></i>
                                    Size
                                </span>
                                <span class="evidence-meta-value">${escapedFileSize}</span>
                            </div>
                            <div class="evidence-meta-item">
                                <span class="evidence-meta-label">
                                    <i data-lucide="tag"></i>
                                    Type
                                </span>
                                <span class="evidence-meta-value">${escapedType}</span>
                            </div>
                        </div>
                        
                        <div class="evidence-hash">
                            <i data-lucide="fingerprint"></i>
                            <span>SHA-256: ${escapedHash}</span>
                        </div>
                        
                        <div class="evidence-actions">
                            <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); verifyEvidence('${escapedId}')">
                                <i data-lucide="shield"></i>
                                Verify
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="event.stopPropagation(); viewChainOfCustody('${escapedId}')">
                                <i data-lucide="link-2"></i>
                                Custody
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }
        
        function filterEvidence() {
            const searchTerm = document.getElementById('searchEvidence').value.toLowerCase();
            
            if (!searchTerm) {
                renderEvidenceGrid(evidenceList);
                return;
            }
            
            const filtered = evidenceList.filter(item => 
                item.fileName.toLowerCase().includes(searchTerm) ||
                item.caseId.toLowerCase().includes(searchTerm) ||
                item.description.toLowerCase().includes(searchTerm) ||
                item.uploadedBy.toLowerCase().includes(searchTerm)
            );
            
            renderEvidenceGrid(filtered);
        }
        
        function viewEvidenceDetails(evidenceId) {
            const evidence = evidenceList.find(e => e.id === evidenceId);
            if (!evidence) return;
            
            // Escape all user-provided content for modal
            const escapedId = escapeHtml(evidence.id);
            const escapedCaseId = escapeHtml(evidence.caseId);
            const escapedFileName = escapeHtml(evidence.fileName);
            const escapedUploadedBy = escapeHtml(evidence.uploadedBy);
            const escapedDate = escapeHtml(formatDate(evidence.uploadedAt));
            const escapedFileSize = escapeHtml(formatFileSize(evidence.fileSize));
            const escapedType = escapeHtml(evidence.type);
            const escapedCapitalizedType = escapeHtml(capitalizeFirst(evidence.type));
            const escapedLocation = escapeHtml(evidence.location || 'Not specified');
            const escapedDescription = escapeHtml(evidence.description || 'No description provided.');
            
            // Fix: Properly handle file hash fallback without "undefined..." bug
            let fileHashDisplay = '7d3a8f9b2c1e5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b';
            if (evidence.fileHash) {
                fileHashDisplay = evidence.fileHash.substring(0, 32) + '...';
            }
            const escapedFileHash = escapeHtml(fileHashDisplay);
            
            // Fix: Properly handle blockchain transaction fallback
            let blockchainTxDisplay = '0x7d3a8f9b2c1e5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b';
            if (evidence.blockchainTx) {
                blockchainTxDisplay = evidence.blockchainTx;
            }
            const escapedBlockchainTx = escapeHtml(blockchainTxDisplay);
            
            const iconName = getEvidenceIcon(evidence.type);
            const statusIcon = evidence.status === 'verified' ? 'shield' : 'clock';
            const statusText = evidence.status === 'verified' ? 'VERIFIED' : 'PENDING';
            
            const modalContent = `
                <div style="display: flex; flex-direction: column; gap: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div style="width: 56px; height: 56px; background: var(--evidence-red-muted); border-radius: 18px; display: flex; align-items: center; justify-content: center;">
                                <i data-lucide="${iconName}" style="width: 28px; height: 28px; color: var(--evidence-red);"></i>
                            </div>
                            <div>
                                <h3 style="font-size: 18px; font-weight: 700; color: var(--evidence-gray-900);">${escapedFileName}</h3>
                                <p style="color: var(--evidence-gray-500); font-size: 13px;">${escapedId}</p>
                            </div>
                        </div>
                        <span class="evidence-status-badge ${evidence.status}">
                            <i data-lucide="${statusIcon}"></i>
                            ${statusText}
                        </span>
                    </div>
                    
                    <div style="background: var(--evidence-red-soft); padding: 24px; border-radius: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <span style="font-size: 12px; color: var(--evidence-gray-500);">Case ID</span>
                                <p style="font-weight: 600; margin-top: 4px; font-family: monospace;">${escapedCaseId}</p>
                            </div>
                            <div>
                                <span style="font-size: 12px; color: var(--evidence-gray-500);">Uploaded By</span>
                                <p style="font-weight: 600; margin-top: 4px;">${escapedUploadedBy}</p>
                            </div>
                            <div>
                                <span style="font-size: 12px; color: var(--evidence-gray-500);">Upload Date</span>
                                <p style="font-weight: 600; margin-top: 4px;">${escapedDate}</p>
                            </div>
                            <div>
                                <span style="font-size: 12px; color: var(--evidence-gray-500);">File Size</span>
                                <p style="font-weight: 600; margin-top: 4px;">${escapedFileSize}</p>
                            </div>
                            <div>
                                <span style="font-size: 12px; color: var(--evidence-gray-500);">Evidence Type</span>
                                <p style="font-weight: 600; margin-top: 4px; text-transform: capitalize;">${escapedCapitalizedType}</p>
                            </div>
                            <div>
                                <span style="font-size: 12px; color: var(--evidence-gray-500);">Collection Location</span>
                                <p style="font-weight: 600; margin-top: 4px;">${escapedLocation}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <span style="font-size: 14px; font-weight: 600; color: var(--evidence-gray-700);">Description</span>
                        <p style="margin-top: 8px; color: var(--evidence-gray-600); line-height: 1.6;">
                            ${escapedDescription}
                        </p>
                    </div>
                    
                    <div style="background: var(--evidence-gray-50); padding: 20px; border-radius: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                            <i data-lucide="fingerprint" style="width: 20px; height: 20px; color: var(--evidence-red);"></i>
                            <span style="font-weight: 600; color: var(--evidence-gray-800);">SHA-256 Hash</span>
                        </div>
                        <code style="display: block; background: var(--evidence-white); padding: 12px; border-radius: 12px; font-family: 'JetBrains Mono', monospace; font-size: 13px; word-break: break-all;">
                            ${escapedFileHash}
                        </code>
                    </div>
                    
                    <div style="background: var(--blockchain-green-light); padding: 20px; border-radius: 16px; border: 1px solid #a7f3d0;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <i data-lucide="link-2" style="width: 20px; height: 20px; color: var(--blockchain-green-dark);"></i>
                            <span style="font-weight: 600; color: var(--blockchain-green-dark);">Blockchain Transaction</span>
                        </div>
                        <code style="display: block; background: white; padding: 12px; border-radius: 12px; font-family: 'JetBrains Mono', monospace; font-size: 13px; word-break: break-all;">
                            ${escapedBlockchainTx}
                        </code>
                        <p style="margin-top: 12px; font-size: 13px; color: var(--blockchain-green-dark); display: flex; align-items: center; gap: 6px;">
                            <i data-lucide="check-circle" style="width: 14px; height: 14px;"></i>
                            Verified on block #19,423,856
                        </p>
                    </div>
                    
                    <div style="display: flex; gap: 16px; margin-top: 8px;">
                        <button class="btn btn-primary" onclick="downloadEvidence('${escapedId}')" style="flex: 1;">
                            <i data-lucide="download"></i>
                            Download File
                        </button>
                        <button class="btn btn-outline" onclick="closeDetailModal()" style="flex: 1;">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('detailModalTitle').textContent = 'Evidence Details';
            document.getElementById('detailModalContent').innerHTML = modalContent;
            document.getElementById('evidenceDetailModal').classList.add('active');
            lucide.createIcons();
        }
        
        function viewChainOfCustody(evidenceId) {
            const evidence = evidenceList.find(e => e.id === evidenceId);
            if (!evidence) return;
            
            // Escape all user-provided content for custody timeline
            const escapedFileName = escapeHtml(evidence.fileName);
            const escapedCaseId = escapeHtml(evidence.caseId);
            const escapedUploadedBy = escapeHtml(evidence.uploadedBy);
            const escapedDateTime = escapeHtml(formatDateTime(evidence.uploadedAt));
            const escapedCurrentUser = escapeHtml(currentUser?.fullName || 'System');
            
            // Fix: Properly handle file hash fallback without "undefined..." bug
            let fileHashDisplay = '7d3a8f9b2c1e5a6b7c8d9e0f1a2b3c4d';
            if (evidence.fileHash) {
                fileHashDisplay = evidence.fileHash.substring(0, 32) + '...';
            }
            const escapedFileHash = escapeHtml(fileHashDisplay);
            
            // Fix: Properly handle blockchain transaction fallback
            let blockchainTxDisplay = '0x7d3a8f9b2c1e5a6b7c8d9e0f1a2b3c4d5e6f7a8b';
            if (evidence.blockchainTx) {
                blockchainTxDisplay = evidence.blockchainTx;
            }
            const escapedBlockchainTx = escapeHtml(blockchainTxDisplay);
            
            const statusIcon = evidence.status === 'verified' ? 'shield' : 'clock';
            const statusText = evidence.status === 'verified' ? 'VERIFIED' : 'PENDING';
            
            const custodyContent = `
                <div style="display: flex; flex-direction: column; gap: 16px; margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="font-size: 16px; font-weight: 600; color: var(--evidence-gray-800);">${escapedFileName}</h3>
                            <p style="color: var(--evidence-gray-500); font-size: 13px;">${escapedCaseId}</p>
                        </div>
                        <span class="evidence-status-badge ${evidence.status}">
                            <i data-lucide="${statusIcon}"></i>
                            ${statusText}
                        </span>
                    </div>
                </div>
                
                <div class="custody-timeline">
                    <div class="timeline-item">
                        <div class="timeline-dot">
                            <i data-lucide="upload"></i>
                        </div>
                        <div class="timeline-content">
                            <h4>Evidence Uploaded</h4>
                            <p style="margin-bottom: 8px;">${escapedFileName} uploaded by ${escapedUploadedBy}</p>
                            <div class="timeline-meta">
                                <span>${escapedDateTime}</span>
                                <span>‚Ä¢</span>
                                <span>IP: 192.168.1.105</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="timeline-item">
                        <div class="timeline-dot">
                            <i data-lucide="hash"></i>
                        </div>
                        <div class="timeline-content">
                            <h4>SHA-256 Hash Generated</h4>
                            <code style="font-size: 12px; background: var(--evidence-gray-100); padding: 4px 8px; border-radius: 4px;">
                                ${escapedFileHash}
                            </code>
                            <div class="timeline-meta" style="margin-top: 8px;">
                                <span>Hash verification complete</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="timeline-item">
                        <div class="timeline-dot">
                            <i data-lucide="link-2"></i>
                        </div>
                        <div class="timeline-content">
                            <h4>Blockchain Timestamped</h4>
                            <p>Transaction submitted to Ethereum network</p>
                            <code style="font-size: 12px; background: var(--evidence-gray-100); padding: 4px 8px; border-radius: 4px; display: block; margin-top: 8px;">
                                ${escapedBlockchainTx}
                            </code>
                            <div class="timeline-meta" style="margin-top: 8px;">
                                <span>Block #19,423,856</span>
                                <span>‚Ä¢</span>
                                <span>Confirmed</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="timeline-item">
                        <div class="timeline-dot">
                            <i data-lucide="eye"></i>
                        </div>
                        <div class="timeline-content">
                            <h4>Evidence Verified</h4>
                            <p>Hash match confirmed ‚Ä¢ Evidence integrity verified</p>
                            <div class="timeline-meta">
                                <span>${escapeHtml(formatDateTime(new Date().toISOString()))}</span>
                                <span>‚Ä¢</span>
                                <span>By: ${escapedCurrentUser}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 24px; padding: 16px; background: var(--blockchain-green-light); border-radius: 16px; border: 1px solid #a7f3d0;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <i data-lucide="shield" style="width: 20px; height: 20px; color: var(--blockchain-green-dark);"></i>
                        <div>
                            <strong style="color: var(--blockchain-green-dark);">Chain of Custody Verified</strong>
                            <p style="font-size: 13px; color: var(--blockchain-green-dark); margin-top: 4px;">
                                This evidence has maintained integrity throughout its lifecycle
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('custodyContent').innerHTML = custodyContent;
            document.getElementById('custodyModal').classList.add('active');
            lucide.createIcons();
        }
        
        function verifyEvidence(evidenceId) {
            const evidence = evidenceList.find(e => e.id === evidenceId);
            if (!evidence) return;
            
            showNotification('üîç Verifying evidence hash on blockchain...', 'info');
            
            setTimeout(() => {
                showNotification('‚úÖ Evidence verified successfully - Hash matches blockchain record', 'success');
            }, 2000);
        }
        
        function downloadEvidence(evidenceId) {
            const escapedId = escapeHtml(evidenceId);
            showNotification(`üì• Preparing download for ${escapedId}...`, 'info');
            setTimeout(() => {
                showNotification('‚úÖ Download started', 'success');
            }, 1000);
        }
        
        function refreshEvidence() {
            showNotification('üîÑ Syncing evidence with blockchain...', 'info');
            setTimeout(() => {
                loadEvidence();
                showNotification('‚úÖ Evidence inventory synced', 'success');
            }, 1500);
        }
        
        function resetForm() {
            document.getElementById('evidenceForm').reset();
            document.getElementById('uploadProgress').classList.remove('active');
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('uploadPercentage').textContent = '0%';
            document.getElementById('uploadStatus').innerHTML = '<i data-lucide="clock"></i> Ready to upload';
            currentFile = null;
            lucide.createIcons();
        }
        
        // ===== UTILITY FUNCTIONS =====
        function getEvidenceIcon(type) {
            const icons = {
                'document': 'file-text',
                'image': 'image',
                'video': 'video',
                'audio': 'mic',
                'digital': 'hard-drive',
                'physical': 'package'
            };
            return icons[type] || 'file';
        }
        
        function truncateFileName(name, maxLength = 25) {
            if (name.length <= maxLength) return name;
            
            const dotIndex = name.lastIndexOf('.');
            
            // Handle files without extension
            if (dotIndex === -1) {
                return name.slice(0, maxLength - 3) + '...';
            }
            
            const ext = name.slice(dotIndex + 1);
            const nameWithoutExt = name.slice(0, dotIndex);
            return nameWithoutExt.slice(0, maxLength - 3 - ext.length) + '...' + ext;
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }
        
        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function capitalizeFirst(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        function showNotification(message, type = 'info') {
            // Escape message to prevent XSS
            const escapedMessage = escapeHtml(message);
            
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 24px;
                right: 24px;
                background: ${type === 'success' ? 'var(--blockchain-green)' : type === 'error' ? 'var(--evidence-red)' : '#3b82f6'};
                color: white;
                padding: 14px 20px;
                border-radius: 16px;
                font-size: 14px;
                font-weight: 500;
                box-shadow: var(--shadow-red-lg);
                z-index: 1100;
                animation: slideIn 0.3s ease;
                max-width: 400px;
                display: flex;
                align-items: center;
                gap: 12px;
                backdrop-filter: blur(8px);
            `;
            
            let icon = 'info';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'alert-circle';
            
            notification.innerHTML = `<i data-lucide="${icon}" style="width: 20px; height: 20px; flex-shrink: 0;"></i>${escapedMessage}`;
            document.body.appendChild(notification);
            lucide.createIcons();
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease forwards';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }
        
        function closeCustodyModal() {
            document.getElementById('custodyModal').classList.remove('active');
        }
        
        function closeDetailModal() {
            document.getElementById('evidenceDetailModal').classList.remove('active');
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const custodyModal = document.getElementById('custodyModal');
            const detailModal = document.getElementById('evidenceDetailModal');
            
            if (event.target === custodyModal) {
                closeCustodyModal();
            }
            if (event.target === detailModal) {
                closeDetailModal();
            }
        }
        
        // Add slideOut animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideOut {
                from {
                    opacity: 1;
                    transform: translateX(0);
                }
                to {
                    opacity: 0;
                    transform: translateX(100%);
                }
            }
        `;
        document.head.appendChild(style);
    </script>
    <script src="footer.js"></script>
</body>

</html>