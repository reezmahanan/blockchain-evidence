<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload | EVID-DGC</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <link rel="shortcut icon" href="favicon.png" type="image/png">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="responsive-improvements.css">
    <link rel="stylesheet" href="enhanced-upload-styles.css">

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KEYDE0ZH4Z"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-KEYDE0ZH4Z');
    </script>
</head>

<body>
    <script src="fixed-navbar.js"></script>

    <div class="container">
        <!-- Evidence Upload Section -->
        <div class="card">
            <div class="card-header">
                <h2>üì§ Upload Evidence</h2>
                <p>Securely upload and hash evidence to blockchain</p>
            </div>
            <div class="card-body">
                <form id="evidenceForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="caseId">üè∑Ô∏è Case ID *</label>
                            <input type="text" id="caseId" class="form-control" placeholder="CASE-2024-001" required>
                        </div>
                        <div class="form-group">
                            <label for="evidenceType">üìã Evidence Type *</label>
                            <select id="evidenceType" class="form-control" required>
                                <option value="">Select Type</option>
                                <option value="document">üìÑ Document</option>
                                <option value="image">üñºÔ∏è Image/Photo</option>
                                <option value="video">üé• Video</option>
                                <option value="audio">üéµ Audio</option>
                                <option value="digital">üíæ Digital File</option>
                                <option value="physical">üì¶ Physical Item</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="evidenceFile">üìÅ Evidence File *</label>
                        <input type="file" id="evidenceFile" class="form-control" required>
                        <div class="file-format-info">
                            <strong>Supported formats:</strong> PDF, JPG, PNG, GIF, MP4, AVI, MOV, MP3, WAV, M4A, DOC,
                            DOCX, XLS, XLSX, TXT, ZIP, RAR<br>
                            <strong>Maximum size:</strong> 100MB (varies by format)
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="description">üìù Description *</label>
                        <textarea id="description" class="form-control" rows="3"
                            placeholder="Detailed description of evidence" required></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="location">üìç Collection Location</label>
                            <input type="text" id="location" class="form-control"
                                placeholder="Where evidence was collected">
                        </div>
                        <div class="form-group">
                            <label for="collectionDate">üìÖ Collection Date</label>
                            <input type="datetime-local" id="collectionDate" class="form-control">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success">
                            ‚õìÔ∏è Upload & Hash to Blockchain
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Evidence List -->
        <div class="card">
            <div class="card-header">
                <h2>üìã Evidence Inventory</h2>
                <div class="card-actions">
                    <input type="text" id="searchEvidence" class="search-input" placeholder="Search evidence...">
                    <button class="btn btn-outline btn-sm" onclick="refreshEvidence()">üîÑ Refresh</button>
                </div>
            </div>
            <div class="card-body">
                <div id="evidenceList" class="evidence-grid">
                    <div class="text-center p-4">
                        <div class="loading mb-4"></div>
                        <p>Loading evidence...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Blockchain Status -->
        <div class="card">
            <div class="card-header">
                <h2>‚õìÔ∏è Blockchain Status</h2>
            </div>
            <div class="card-body">
                <div class="blockchain-status">
                    <div class="status-item">
                        <span class="status-label">Network:</span>
                        <span id="networkStatus" class="status-value">Checking...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Block Height:</span>
                        <span id="blockHeight" class="status-value">Loading...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Gas Price:</span>
                        <span id="gasPrice" class="status-value">Loading...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Contract:</span>
                        <span id="contractStatus" class="status-value">Checking...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Evidence Detail Modal -->
    <div id="evidenceModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2 id="evidenceModalTitle">Evidence Details</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="evidenceModalContent" class="modal-body">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <script src="config.js"></script>
    <script src="storage.js"></script>
    <script src="analytics.js"></script>
    <script src="enhanced-evidence-upload.js"></script>
    <script>
        let currentUser = null;
        let web3 = null;
        let evidenceContract = null;
        let evidenceList = [];

        // Smart contract ABI (simplified)
        const contractABI = [
            {
                "inputs": [{ "type": "string", "name": "_hash" }, { "type": "string", "name": "_metadata" }],
                "name": "storeEvidence",
                "outputs": [{ "type": "uint256" }],
                "type": "function"
            },
            {
                "inputs": [{ "type": "uint256", "name": "_id" }],
                "name": "getEvidence",
                "outputs": [{ "type": "string" }, { "type": "string" }, { "type": "address" }, { "type": "uint256" }],
                "type": "function"
            }
        ];

        document.addEventListener('DOMContentLoaded', async function () {
            await initializeEvidenceManager();
        });

        async function initializeEvidenceManager() {
            try {
                const wallet = localStorage.getItem('currentUser');
                if (!wallet) {
                    window.location.href = 'index.html';
                    return;
                }

                // Load user data
                currentUser = await loadUserData(wallet);
                if (!currentUser) {
                    window.location.href = 'index.html';
                    return;
                }

                updateUserUI(currentUser);
                await initializeWeb3();
                await loadEvidence();
                await updateBlockchainStatus();

                // Set up form handler
                document.getElementById('evidenceForm').addEventListener('submit', handleEvidenceUpload);
                document.getElementById('searchEvidence').addEventListener('input', filterEvidence);

            } catch (error) {
                console.error('Initialization error:', error);
                showAlert('Failed to initialize evidence manager', 'error');
            }
        }

        async function loadUserData(wallet) {
            try {
                if (typeof storage !== 'undefined') {
                    const user = await storage.getUser(wallet);
                    if (user) return user;
                }

                const savedUser = localStorage.getItem('evidUser_' + wallet);
                return savedUser ? JSON.parse(savedUser) : null;
            } catch (error) {
                console.error('Error loading user data:', error);
                return null;
            }
        }

        function updateUserUI(user) {
            const roleName = getRoleName(user.role);
            document.getElementById('userRole').textContent = roleName;
            document.getElementById('userRole').className = `badge badge-${getRoleClass(user.role)}`;
            document.getElementById('userWallet').textContent = user.wallet_address.substring(0, 8) + '...';
        }

        async function initializeWeb3() {
            try {
                if (window.ethereum) {
                    web3 = new Web3(window.ethereum);

                    // Mock contract address - replace with actual deployed contract
                    const contractAddress = '0x1234567890123456789012345678901234567890';
                    evidenceContract = new web3.eth.Contract(contractABI, contractAddress);

                    document.getElementById('contractStatus').textContent = '‚úÖ Connected';
                } else {
                    document.getElementById('contractStatus').textContent = '‚ùå No Web3';
                }
            } catch (error) {
                console.error('Web3 initialization error:', error);
                document.getElementById('contractStatus').textContent = '‚ùå Error';
            }
        }

        async function handleEvidenceUpload(event) {
            event.preventDefault();

            try {
                const file = document.getElementById('evidenceFile').files[0];

                if (!file) {
                    evidenceUploader.showError('Please select a file');
                    return;
                }

                // Validate file using enhanced uploader
                if (!evidenceUploader.validateFile(file)) {
                    return;
                }

                const formData = new FormData();
                formData.append('file', file);
                formData.append('caseId', document.getElementById('caseId').value);
                formData.append('type', document.getElementById('evidenceType').value);
                formData.append('description', document.getElementById('description').value);
                formData.append('location', document.getElementById('location').value);
                formData.append('collectionDate', document.getElementById('collectionDate').value);
                formData.append('uploadedBy', currentUser.wallet_address);

                // Use enhanced uploader for progress tracking
                const result = await evidenceUploader.handleUpload(formData, file);

                // Calculate file hash
                const fileHash = await calculateFileHash(file);

                // Create evidence metadata
                const evidenceData = {
                    id: 'EVD-' + Date.now(),
                    caseId: document.getElementById('caseId').value,
                    type: document.getElementById('evidenceType').value,
                    description: document.getElementById('description').value,
                    location: document.getElementById('location').value,
                    collectionDate: document.getElementById('collectionDate').value,
                    fileName: file.name,
                    fileSize: file.size,
                    fileHash: fileHash,
                    uploadedBy: currentUser.wallet_address,
                    uploadedAt: new Date().toISOString(),
                    status: 'uploaded',
                    blockchainTx: null
                };

                // Store to blockchain (mock implementation)
                try {
                    const txHash = await storeToBlockchain(fileHash, JSON.stringify(evidenceData));
                    evidenceData.blockchainTx = txHash;
                    evidenceData.status = 'blockchain_confirmed';
                } catch (error) {
                    console.error('Blockchain storage failed:', error);
                    evidenceData.status = 'blockchain_pending';
                }

                // Store evidence data
                await storeEvidenceData(evidenceData);

                // Track analytics
                if (typeof trackEvent === 'function') {
                    trackEvent('evidence_uploaded', {
                        event_category: 'evidence_management',
                        evidence_type: evidenceData.type,
                        file_size: evidenceData.fileSize
                    });
                }

                document.getElementById('evidenceForm').reset();
                evidenceUploader.clearFileInput();
                await loadEvidence();

            } catch (error) {
                console.error('Upload error:', error);
                evidenceUploader.showError('Upload failed: ' + error.message);
            }
        }

        async function calculateFileHash(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = async function (e) {
                    const buffer = e.target.result;
                    const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                    resolve(hashHex);
                };
                reader.readAsArrayBuffer(file);
            });
        }

        async function storeToBlockchain(hash, metadata) {
            // Mock blockchain transaction
            return new Promise((resolve) => {
                setTimeout(() => {
                    resolve('0x' + Math.random().toString(16).substr(2, 64));
                }, 2000);
            });
        }

        async function storeEvidenceData(evidenceData) {
            // Store in localStorage for now
            const existingEvidence = JSON.parse(localStorage.getItem('evidence_' + currentUser.wallet_address) || '[]');
            existingEvidence.push(evidenceData);
            localStorage.setItem('evidence_' + currentUser.wallet_address, JSON.stringify(existingEvidence));
        }

        async function loadEvidence() {
            try {
                const evidence = JSON.parse(localStorage.getItem('evidence_' + currentUser.wallet_address) || '[]');
                evidenceList = evidence;
                renderEvidence(evidenceList);
            } catch (error) {
                console.error('Error loading evidence:', error);
                document.getElementById('evidenceList').innerHTML = '<p class="text-center text-muted">Error loading evidence</p>';
            }
        }

        function renderEvidence(evidence) {
            const container = document.getElementById('evidenceList');

            if (evidence.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No evidence uploaded yet</p>';
                return;
            }

            const evidenceHtml = evidence.map(item => `
                <div class="evidence-card" onclick="viewEvidence('${item.id}')">
                    <div class="evidence-header">
                        <h3>${item.fileName}</h3>
                        <span class="badge badge-${getStatusClass(item.status)}">${item.status}</span>
                    </div>
                    <div class="evidence-meta">
                        <p><strong>Case:</strong> ${item.caseId}</p>
                        <p><strong>Type:</strong> ${item.type}</p>
                        <p><strong>Size:</strong> ${formatFileSize(item.fileSize)}</p>
                        <p><strong>Hash:</strong> ${item.fileHash.substring(0, 16)}...</p>
                    </div>
                    <div class="evidence-actions">
                        <button class="btn btn-sm btn-outline" onclick="event.stopPropagation(); verifyHash('${item.id}')">
                            üîç Verify Hash
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="event.stopPropagation(); viewChainOfCustody('${item.id}')">
                            ‚õìÔ∏è Chain of Custody
                        </button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = evidenceHtml;
        }

        function filterEvidence() {
            const searchTerm = document.getElementById('searchEvidence').value.toLowerCase();
            const filtered = evidenceList.filter(item =>
                item.fileName.toLowerCase().includes(searchTerm) ||
                item.caseId.toLowerCase().includes(searchTerm) ||
                item.description.toLowerCase().includes(searchTerm)
            );
            renderEvidence(filtered);
        }

        async function updateBlockchainStatus() {
            try {
                if (web3) {
                    const network = await web3.eth.net.getNetworkType();
                    const blockNumber = await web3.eth.getBlockNumber();
                    const gasPrice = await web3.eth.getGasPrice();

                    document.getElementById('networkStatus').textContent = network;
                    document.getElementById('blockHeight').textContent = blockNumber;
                    document.getElementById('gasPrice').textContent = web3.utils.fromWei(gasPrice, 'gwei') + ' Gwei';
                } else {
                    document.getElementById('networkStatus').textContent = 'Not connected';
                    document.getElementById('blockHeight').textContent = 'N/A';
                    document.getElementById('gasPrice').textContent = 'N/A';
                }
            } catch (error) {
                console.error('Blockchain status error:', error);
            }
        }

        function viewEvidence(evidenceId) {
            const evidence = evidenceList.find(e => e.id === evidenceId);
            if (!evidence) return;

            document.getElementById('evidenceModalTitle').textContent = evidence.fileName;
            document.getElementById('evidenceModalContent').innerHTML = `
                <div class="evidence-details">
                    <div class="detail-section">
                        <h3>üìã Basic Information</h3>
                        <p><strong>Evidence ID:</strong> ${evidence.id}</p>
                        <p><strong>Case ID:</strong> ${evidence.caseId}</p>
                        <p><strong>Type:</strong> ${evidence.type}</p>
                        <p><strong>Description:</strong> ${evidence.description}</p>
                        <p><strong>Collection Location:</strong> ${evidence.location || 'Not specified'}</p>
                        <p><strong>Collection Date:</strong> ${evidence.collectionDate || 'Not specified'}</p>
                    </div>
                    <div class="detail-section">
                        <h3>üîê Cryptographic Hash</h3>
                        <p><strong>SHA-256:</strong> <code>${evidence.fileHash}</code></p>
                        <p><strong>File Size:</strong> ${formatFileSize(evidence.fileSize)}</p>
                        <p><strong>Blockchain TX:</strong> ${evidence.blockchainTx || 'Pending'}</p>
                    </div>
                    <div class="detail-section">
                        <h3>üë§ Chain of Custody</h3>
                        <p><strong>Uploaded By:</strong> ${evidence.uploadedBy}</p>
                        <p><strong>Upload Date:</strong> ${new Date(evidence.uploadedAt).toLocaleString()}</p>
                        <p><strong>Status:</strong> <span class="badge badge-${getStatusClass(evidence.status)}">${evidence.status}</span></p>
                    </div>
                </div>
            `;
            document.getElementById('evidenceModal').classList.add('active');
        }

        function verifyHash(evidenceId) {
            showAlert('Hash verification feature coming soon!', 'info');
        }

        function viewChainOfCustody(evidenceId) {
            showAlert('Chain of custody viewer coming soon!', 'info');
        }

        function refreshEvidence() {
            loadEvidence();
            updateBlockchainStatus();
        }

        function getRoleName(role) {
            const roleMap = {
                'public_viewer': 'Public Viewer', 'investigator': 'Investigator',
                'forensic_analyst': 'Forensic Analyst', 'legal_professional': 'Legal Professional',
                'court_official': 'Court Official', 'evidence_manager': 'Evidence Manager',
                'auditor': 'Auditor', 'admin': 'Administrator',
                1: 'Public Viewer', 2: 'Investigator', 3: 'Forensic Analyst',
                4: 'Legal Professional', 5: 'Court Official', 6: 'Evidence Manager',
                7: 'Auditor', 8: 'Administrator'
            };
            return roleMap[role] || 'Unknown';
        }

        function getRoleClass(role) {
            const classes = {
                'public_viewer': 'public', 'investigator': 'investigator', 'forensic_analyst': 'forensic',
                'legal_professional': 'legal', 'court_official': 'court', 'evidence_manager': 'manager',
                'auditor': 'auditor', 'admin': 'admin',
                1: 'public', 2: 'investigator', 3: 'forensic', 4: 'legal',
                5: 'court', 6: 'manager', 7: 'auditor', 8: 'admin'
            };
            return classes[role] || 'public';
        }

        function getStatusClass(status) {
            const classes = {
                'uploaded': 'warning',
                'blockchain_confirmed': 'success',
                'blockchain_pending': 'info',
                'verified': 'success',
                'sealed': 'dark'
            };
            return classes[status] || 'secondary';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => modal.classList.remove('active'));
        }

        function showLoading(show) {
            // Simple loading implementation
            const form = document.getElementById('evidenceForm');
            const submitBtn = form.querySelector('button[type="submit"]');
            if (show) {
                submitBtn.disabled = true;
                submitBtn.textContent = '‚è≥ Processing...';
            } else {
                submitBtn.disabled = false;
                submitBtn.textContent = '‚õìÔ∏è Upload & Hash to Blockchain';
            }
        }

        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;
            alert.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 1000;
                padding: 12px 20px; border-radius: 8px; color: white; font-weight: 500;
                max-width: 400px; background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
            `;
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }
    </script>

    <style>
        .evidence-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .evidence-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .evidence-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .evidence-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .evidence-meta p {
            margin: 5px 0;
            font-size: 0.9rem;
        }

        .evidence-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .blockchain-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .search-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }

        .detail-section {
            margin-bottom: 30px;
        }

        .detail-section h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .detail-section code {
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: monospace;
            word-break: break-all;
        }
    </style>
    <script src="footer.js"></script>
</body>

</html>